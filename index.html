<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Master Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&family=Libre+Baskerville&display=swap" rel="stylesheet">
    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body {
            font-family: 'Libre Baskerville', serif;
            background-color: #1a1a1a;
            color: #f3f3f3;
        }
        .font-title {
            font-family: 'IM Fell English SC', serif;
        }
        .card {
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .input-field {
            background-color: #383838;
            border: 1px solid #555;
            color: #f3f3f3;
            border-radius: 4px;
        }
        .btn {
            background-color: #8b0000;
            color: #f3f3f3;
            border: 1px solid #a52a2a;
            transition: all 0.2s ease-in-out;
        }
        .btn:hover {
            background-color: #a52a2a;
            box-shadow: 0 0 10px #ff4500;
        }
        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        .btn-google {
            background-color: #4285F4;
            border-color: #4285F4;
        }
        .btn-google:hover {
            background-color: #5a95f5;
        }
        .output-box {
            background-color: #222;
            border: 1px solid #444;
            min-height: 150px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .turn-active {
            background-color: #a52a2a !important; /* Brighter red */
            color: #fff;
            border-left: 6px solid #ff4500;
            transform: scale(1.02);
            box-shadow: 0 0 12px rgba(255, 69, 0, 0.6);
            transition: all 0.2s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b0000;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            background-color: #383838;
            border: 1px solid #555;
        }
        .tab-btn-active {
            background-color: #8b0000;
            border-color: #a52a2a;
        }
        #map-board, #combat-map-board {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            overflow: hidden;
        }
        #map-grid, #combat-map-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px), linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 5% 5%;
            pointer-events: none;
        }
        .token {
            position: absolute;
            width: 4%;
            height: 4%;
            cursor: grab;
            user-select: none;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.7));
        }
        .token svg {
            width: 100%;
            height: 100%;
        }
        .token.player svg { fill: #3b82f6; stroke: #fff; stroke-width: 2px; }
        .token.enemy svg { fill: #dc2626; stroke: #fff; stroke-width: 2px; }
        .token.dragging { cursor: grabbing; z-index: 1000; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.9));}
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 50;
            display: flex; /* Changed for easier centering */
        }
        .dice-bowl {
            background-color: #1a1a1a;
            border: 2px dashed #444;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #f3f3f3;
        }
        .dice-btn {
            background-color: #383838;
        }
        .dice-btn:hover {
            background-color: #555;
        }
        #tokenTooltip {
            position: fixed;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
            z-index: 2000;
            transition: opacity 0.2s;
        }
        .library-item {
            border: 1px solid #444;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .library-item:hover {
            border-color: #a52a2a;
        }
        .folder-item {
            background-color: #383838;
        }
        .breadcrumb-link {
            cursor: pointer;
            text-decoration: underline;
        }
        .creator-step {
            display: none;
        }
        .creator-step.active {
            display: block;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="text-center mb-8 relative">
        <h1 class="font-title text-5xl md:text-7xl text-red-700 tracking-wider">Dungeon Master Helper</h1>
        <p class="text-gray-400">Your AI-powered companion for epic adventures.</p>
        <div id="auth-container" class="absolute top-0 right-0 p-4">
            <button id="login-btn" class="btn btn-google font-title py-2 px-4 rounded-md">Login with Google</button>
            <div id="user-info" class="hidden items-center">
                <span id="user-name" class="mr-4"></span>
                <button id="logout-btn" class="btn font-title py-2 px-4 rounded-md">Logout</button>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="flex flex-wrap justify-center mb-8 border-b border-gray-700">
        <button id="tab-session" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Session</button>
        <button id="tab-creator" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Creator</button>
        <button id="tab-combat" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg hidden">Combat</button>
        <button id="tab-map" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Map</button>
        <button id="tab-dice" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Dice</button>
        <button id="tab-generators" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Generators</button>
        <button id="tab-characters" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Characters</button>
        <button id="tab-account" class="tab-btn font-title text-xl py-2 px-6 rounded-t-lg">Account</button>
    </div>

    <main>
        <!-- Session Tab Content -->
        <div id="content-session" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-8">
                    <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Random Event Generator</h2>
                        <input type="text" id="eventEnvironment" class="input-field w-full p-2 mb-4" placeholder="Environment (e.g., Forest, City)">
                        <button id="generateEventBtn" class="btn font-title w-full py-2 rounded-md">Generate Random Event</button>
                        <div id="eventOutput" class="output-box mt-4 p-4 rounded-md"></div>
                    </section>
                    <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Combat Generator</h2>
                        <input type="text" id="combatEnvironment" class="input-field w-full p-2 mb-4" placeholder="Environment (e.g., Forest, Cave)">
                        <button id="generateCombatBtn" class="btn font-title w-full py-2 rounded-md">Generate Combat Encounter</button>
                        <div id="combatOutput" class="output-box mt-4 p-4 rounded-md"></div>
                        <div id="monsterSelection" class="mt-4 hidden">
                            <h3 class="font-title text-2xl mb-2">Select Monsters:</h3>
                            <div id="monsterCheckboxContainer" class="space-y-2"></div>
                             <button id="startCombatBtn" class="btn font-title w-full py-2 rounded-md mt-4">Start Combat</button>
                        </div>
                    </section>
                </div>
                <div class="space-y-8">
                     <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Current Party</h2>
                        <ul id="partyList" class="space-y-2 mb-4 text-gray-300"></ul>
                        <p id="party-empty-msg">Add characters from the 'Characters' tab.</p>
                    </section>
                     <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">XP Calculator</h2>
                        <input type="number" id="totalXp" class="input-field w-full p-2 mb-4" placeholder="Total XP from Encounter">
                        <button id="calculateXpBtn" class="btn font-title w-full py-2 rounded-md">Distribute XP</button>
                        <div id="xpOutput" class="output-box mt-4 p-4 rounded-md"></div>
                    </section>
                </div>
            </div>
        </div>

        <!-- Character Creator Tab -->
        <div id="content-creator" class="hidden">
            <section class="card p-6">
                <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Character Creator</h2>
                <div id="character-creator-container">
                    <!-- Step 1: Race and Subrace -->
                    <div id="creator-step-1" class="creator-step active">
                        <h3 class="font-title text-2xl mb-2">Step 1: Choose Your Race</h3>
                        <select id="race-select" class="input-field w-full p-2 mb-4"></select>
                        <select id="subrace-select" class="input-field w-full p-2 mb-4 hidden"></select>
                        <p id="race-description" class="text-gray-400 mb-4"></p>
                        <button id="creator-next-1" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                    <!-- Step 2: Class and Subclass/Origin -->
                    <div id="creator-step-2" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 2: Choose Your Class</h3>
                        <select id="class-select" class="input-field w-full p-2 mb-4"></select>
                        <select id="subclass-select" class="input-field w-full p-2 mb-4 hidden"></select>
                        <p id="class-description" class="text-gray-400 mb-4"></p>
                        <button id="creator-prev-2" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="creator-next-2" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                    <!-- Step 3: Ability Scores -->
                    <div id="creator-step-3" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 3: Determine Ability Scores</h3>
                        <p>You have <span id="points-remaining">27</span> points to spend. (Point-Buy System)</p>
                        <div id="ability-scores" class="grid grid-cols-2 md:grid-cols-3 gap-4 my-4"></div>
                        <button id="creator-prev-3" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="creator-next-3" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                    <!-- Step 4: Background -->
                    <div id="creator-step-4" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 4: Choose Background</h3>
                        <select id="background-select" class="input-field w-full p-2 mb-4"></select>
                        <p id="background-description" class="text-gray-400 mb-4"></p>
                        <button id="creator-prev-4" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="creator-next-4" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                    <!-- Step 5: Description & Details -->
                    <div id="creator-step-5" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 5: Describe Your Character</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="font-bold">Name</label>
                                <input type="text" id="creator-char-name" class="input-field w-full p-2" placeholder="Character Name">
                            </div>
                            <div>
                                <label class="font-bold">Alignment</label>
                                <select id="alignment-select" class="input-field w-full p-2"></select>
                            </div>
                            <div>
                                <label class="font-bold">Age</label>
                                <input type="number" id="age-input" class="input-field w-full p-2" placeholder="Age">
                            </div>
                            <div>
                                <label class="font-bold">Height</label>
                                <input type="text" id="height-input" class="input-field w-full p-2" placeholder="Height (e.g., 5'10'')">
                            </div>
                            <div>
                                <label class="font-bold">Weight</label>
                                <input type="text" id="weight-input" class="input-field w-full p-2" placeholder="Weight (e.g., 180 lbs)">
                            </div>
                            <div>
                                <label class="font-bold">Eyes</label>
                                <input type="text" id="eyes-input" class="input-field w-full p-2" placeholder="Eye Color">
                            </div>
                            <div>
                                <label class="font-bold">Skin</label>
                                <input type="text" id="skin-input" class="input-field w-full p-2" placeholder="Skin Tone">
                            </div>
                            <div>
                                <label class="font-bold">Hair</label>
                                <input type="text" id="hair-input" class="input-field w-full p-2" placeholder="Hair Description">
                            </div>
                        </div>
                        <div id="personality-traits-container" class="mt-4"></div>
                        <div id="languages-container" class="mt-4"></div>
                        <textarea id="backstory-input" class="input-field w-full p-2 mt-4" rows="4" placeholder="Character Backstory..."></textarea>
                        <button id="creator-prev-5" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500 mt-4">Previous</button>
                        <button id="creator-next-5" class="btn font-title py-2 px-4 rounded-md mt-4">Next</button>
                    </div>

                    <!-- Step 6: Proficiencies, Feats & Abilities -->
                    <div id="creator-step-6" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 6: Proficiencies, Feats & Abilities</h3>
                        <div id="proficiencies-container" class="mb-4 max-h-96 overflow-y-auto"></div>
                        <div id="feats-container" class="mb-4"></div>
                        <div id="feats-abilities-container" class="mb-4"></div>
                        <button id="creator-prev-6" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="creator-next-6" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                    <!-- Step 7: Equipment -->
                    <div id="creator-step-7" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 7: Choose Equipment</h3>
                        <div id="equipment-container" class="mb-4 max-h-96 overflow-y-auto"></div>
                        <button id="creator-prev-7" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="creator-next-7" class="btn font-title py-2 px-4 rounded-md">Next</button>
                    </div>

                     <!-- Step 8: Spells -->
                    <div id="creator-step-8" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 8: Choose Your Spells</h3>
                        <div id="spells-container" class="space-y-4 max-h-96 overflow-y-auto"></div>
                        <button id="creator-prev-8" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500 mt-4">Previous</button>
                        <button id="creator-next-8" class="btn font-title py-2 px-4 rounded-md mt-4">Next</button>
                    </div>
                    
                    <!-- Step 9: Review -->
                    <div id="creator-step-9" class="creator-step">
                        <h3 class="font-title text-2xl mb-2">Step 9: Review Your Character</h3>
                        <div id="review-output" class="output-box p-4 rounded-md mb-4 max-h-[60vh] overflow-y-auto"></div>
                        <button id="creator-prev-9" class="btn font-title py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">Previous</button>
                        <button id="finish-character-btn" class="btn font-title py-2 px-4 rounded-md">Save Character</button>
                    </div>
                </div>
            </section>
        </div>


        <!-- Combat Tab Content -->
        <div id="content-combat" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <section class="card p-6">
                        <div class="flex justify-between items-center border-b-2 border-red-700 pb-2 mb-4">
                            <h2 class="font-title text-3xl">Battle Map</h2>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="combat-toggle-grid" class="input-field" checked><span>Grid</span></label>
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="combat-toggle-tokens" class="input-field" checked><span>Tokens</span></label>
                            </div>
                        </div>
                        <div id="combat-map-board" class="bg-black rounded-md">
                            <img id="combat-map-image" class="w-full h-full object-cover" alt="Combat Map">
                            <div id="combat-map-grid"></div>
                            <div id="combat-token-container"></div>
                        </div>
                    </section>
                </div>
                <div class="lg:col-span-1 space-y-8">
                    <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Turn Tracker</h2>
                        <ul id="turnOrder" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></ul>
                        <div class="flex gap-2">
                            <button id="nextTurnBtn" class="btn font-title flex-grow py-2 rounded-md">Next Turn</button>
                            <button id="endCombatBtn" class="btn font-title flex-grow py-2 rounded-md bg-gray-700 hover:bg-gray-600">End Combat</button>
                        </div>
                    </section>
                     <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Active Creature</h2>
                        <div id="statBlockOutput" class="output-box p-4 rounded-md max-h-96 overflow-y-auto"></div>
                    </section>
                </div>
            </div>
        </div>

        <!-- Map Tab Content (for non-combat maps) -->
        <div id="content-map" class="hidden">
            <div class="space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <section class="card p-6">
                            <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">World/Town Map Generator</h2>
                            <input type="text" id="mapPrompt" class="input-field w-full p-2 mb-4" placeholder="e.g., A bustling port city market">
                            <button id="generateMapImageBtn" class="btn font-title w-full py-2 rounded-md">Generate Map Image</button>
                             <div id="mapActions" class="hidden flex gap-2 mt-4">
                                <button id="saveMapBtn" class="btn font-title flex-grow py-2 rounded-md bg-blue-700 hover:bg-blue-600">Save</button>
                                <button id="downloadMapBtn" class="btn font-title flex-grow py-2 rounded-md bg-green-700 hover:bg-green-600">Download</button>
                            </div>
                        </section>
                    </div>
                    <div class="lg:col-span-2">
                         <section class="card p-6">
                            <div class="flex justify-between items-center border-b-2 border-red-700 pb-2 mb-4">
                                <h2 class="font-title text-3xl">Generated Map</h2>
                                 <div class="flex items-center space-x-4">
                                    <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="map-toggle-grid" class="input-field"><span>Grid</span></label>
                                    <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="map-toggle-tokens" class="input-field" checked><span>Player Tokens</span></label>
                                </div>
                            </div>
                            <div id="map-board" class="bg-black rounded-md">
                                <img id="mapImageOutput" class="w-full h-full object-cover" alt="Generated Map">
                                <div id="map-grid" class="hidden"></div>
                                <div id="map-token-container"></div>
                            </div>
                        </section>
                    </div>
                </div>
                 <section class="card p-6">
                    <div class="flex justify-between items-center border-b-2 border-red-700 pb-2 mb-4">
                        <h2 class="font-title text-3xl">Map Library</h2>
                        <button id="newFolderBtn" class="btn text-sm py-1 px-3 rounded-md">+ New Folder</button>
                    </div>
                    <div id="mapBreadcrumbs" class="text-gray-400 mb-4"></div>
                    <div id="mapLibraryContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 min-h-[200px]">
                        <!-- Saved maps will be injected here -->
                    </div>
                </section>
            </div>
        </div>


        <!-- Dice Tab Content -->
        <div id="content-dice" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Dice Roller</h2>
                        <div class="dice-bowl rounded-lg mb-4 p-4">
                            <span id="diceTotal" class="font-title text-7xl">0</span>
                            <span id="diceBreakdown" class="text-lg text-gray-400 mt-2 h-6"></span>
                        </div>
                        <div id="dice-buttons" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d20" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="20" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D20</button>
                            </div>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d12" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="12" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D12</button>
                            </div>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d10" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="10" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D10</button>
                            </div>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d100" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="100" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D100</button>
                            </div>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d6" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="6" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D6</button>
                            </div>
                             <div class="flex items-center space-x-2">
                                <input type="number" id="qty-d4" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="4" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D4</button>
                            </div>
                             <div class="flex items-center space-x-2 col-span-2 md:col-span-1 md:col-start-2">
                                <input type="number" id="qty-d3" value="1" min="1" max="100" class="input-field w-16 p-2 text-center rounded-md">
                                <button data-die="3" class="btn dice-btn flex-grow py-3 rounded-md font-title text-xl">D3</button>
                            </div>
                        </div>
                    </section>
                </div>
                <div>
                    <section class="card p-6">
                        <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Roll Log</h2>
                        <ul id="rollLog" class="space-y-2 text-gray-400"></ul>
                    </section>
                </div>
            </div>
        </div>

        <!-- Generators Tab Content -->
        <div id="content-generators" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <section id="loot-generator" class="card p-6">
                    <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Loot Generator</h2>
                    <input type="text" id="lootPlayerClass" class="input-field w-full p-2 mb-4" placeholder="Player Class (e.g., Fighter)">
                    <button id="generateLootBtn" class="btn font-title w-full py-2 rounded-md">Generate Loot for Party</button>
                    <div id="lootOutput" class="output-box mt-4 p-4 rounded-md"></div>
                </section>
                <section id="shop-generator" class="card p-6">
                    <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Shop Generator</h2>
                    <select id="shopType" class="input-field w-full p-2 mb-4">
                        <option>Blacksmith</option>
                        <option>Brewery</option>
                        <option>General Goods</option>
                        <option>Mercantile</option>
                        <option>Alchemist</option>
                        <option>Magic Shop</option>
                    </select>
                    <button id="generateShopBtn" class="btn font-title w-full py-2 rounded-md">Generate Shop Inventory</button>
                    <div id="shopOutput" class="output-box mt-4 p-4 rounded-md"></div>
                </section>
            </div>
        </div>

        <!-- Characters Tab Content -->
        <div id="content-characters" class="hidden">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <section id="character-storage" class="card p-6">
                    <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Character Manager</h2>
                    <div class="space-y-3 mb-4">
                        <input type="text" id="charName" class="input-field w-full p-2" placeholder="Character Name">
                        <input type="text" id="charClass" class="input-field w-full p-2" placeholder="Class & Level (e.g., Barbarian 5)">
                        <textarea id="charNotes" rows="4" class="input-field w-full p-2" placeholder="Character Notes, Stats, Inventory..."></textarea>
                    </div>
                    <button id="saveCharBtn" class="btn font-title w-full py-2 rounded-md mb-2">Save Character</button>
                </section>
                <section id="saved-characters-list" class="card p-6">
                     <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Saved Characters</h2>
                     <div id="savedCharsContainer"></div>
                </section>
            </div>
        </div>

        <!-- Account Tab Content -->
        <div id="content-account" class="hidden">
            <section class="card p-6">
                <h2 class="font-title text-3xl border-b-2 border-red-700 pb-2 mb-4">Account Information</h2>
                <div id="account-info">
                    <p>Status: <span id="subscription-status" class="font-bold">Free Tier</span></p>
                    <p id="api-calls-container">API Calls Remaining: <span id="api-calls-remaining">10</span>/10</p>
                </div>
                <div id="subscription-options" class="mt-8">
                    <h3 class="font-title text-2xl mb-4">Upgrade to Premium</h3>
                    <div class="card p-6 bg-gray-800">
                        <h4 class="font-title text-xl">Monthly Subscription</h4>
                        <p class="text-gray-400 mb-4">Unlock unlimited AI generations for a whole month!</p>
                        <p class="text-3xl font-bold mb-4">$4.99 / Month</p>
                        <button id="subscribe-btn" class="btn font-title w-full py-2 rounded-md">Subscribe Now</button>
                    </div>
                </div>
            </section>
        </div>

    </main>

    <!-- Combat Scene Modal -->
    <div id="combatSceneModal" class="modal-backdrop items-center justify-center hidden">
        <div class="card p-8 rounded-lg w-full max-w-xl space-y-4">
            <h2 class="font-title text-4xl">Describe the Combat Scene</h2>
            <p class="text-gray-400">Describe the environment where the combat will take place. This will generate the battle map.</p>
            <textarea id="combatScenePrompt" class="input-field w-full p-2" rows="4" placeholder="e.g., A crumbling stone altar in the center of a dark, swampy clearing. Strange glyphs glow faintly on the stone."></textarea>
            <div class="flex gap-4">
                <button id="generateCombatMapBtn" class="btn font-title flex-grow py-2 rounded-md">Generate Map & Start</button>
                <button id="cancelCombatMapBtn" class="btn font-title flex-grow py-2 rounded-md bg-gray-600 hover:bg-gray-500">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal -->
    <div id="customModal" class="modal-backdrop items-center justify-center hidden">
        <div class="card p-8 rounded-lg w-full max-w-md space-y-4 text-center">
            <p id="customModalMessage" class="text-lg"></p>
            <div id="customModalButtons" class="flex gap-4 justify-center">
                <!-- Buttons are injected here by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Custom Prompt Modal -->
    <div id="customPromptModal" class="modal-backdrop items-center justify-center hidden">
        <div class="card p-8 rounded-lg w-full max-w-md space-y-4">
            <p id="customPromptMessage" class="text-lg"></p>
            <input type="text" id="customPromptInput" class="input-field w-full p-2">
            <div id="customPromptButtons" class="flex gap-4 justify-center">
                 <!-- Buttons are injected here by JavaScript -->
            </div>
        </div>
    </div>


    <div id="tokenTooltip" class="hidden opacity-0"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Configuration ---
            // IMPORTANT: Replace the placeholder values below with your actual Firebase project configuration.
            // You can find this in your Firebase project settings.
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            // --- Initialize Firebase ---
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- STATE MANAGEMENT ---
            let user = null;
            let subscriptionActive = false;
            let apiCalls = 10;
            let turnOrder = [];
            let currentTurnIndex = -1;
            let characters = {};
            let party = [];
            let lastGeneratedEnemies = [];
            let monsterStatBlocks = {};
            let rollHistory = [];
            let tokens = []; // { id, x, y, type, element }
            let activeToken = null;
            let offsetX, offsetY;
            let mapLibrary = { folders: {}, maps: [] };
            let currentMapPath = [];
            let currentMapData = null;
            let creatorData = {};


            // --- DOM ELEMENT REFERENCES ---
            const authContainer = document.getElementById('auth-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');

            const mainContent = {
                session: document.getElementById('content-session'),
                creator: document.getElementById('content-creator'),
                combat: document.getElementById('content-combat'),
                map: document.getElementById('content-map'),
                dice: document.getElementById('content-dice'),
                generators: document.getElementById('content-generators'),
                characters: document.getElementById('content-characters'),
                account: document.getElementById('content-account'),

            };
            const TABS = {
                session: document.getElementById('tab-session'),
                creator: document.getElementById('tab-creator'),
                combat: document.getElementById('tab-combat'),
                map: document.getElementById('tab-map'),
                dice: document.getElementById('tab-dice'),
                generators: document.getElementById('tab-generators'),
                characters: document.getElementById('tab-characters'),
                account: document.getElementById('tab-account'),
            };

            const lootPlayerClassInput = document.getElementById('lootPlayerClass');
            const generateLootBtn = document.getElementById('generateLootBtn');
            const lootOutput = document.getElementById('lootOutput');

            const shopTypeSelect = document.getElementById('shopType');
            const generateShopBtn = document.getElementById('generateShopBtn');
            const shopOutput = document.getElementById('shopOutput');

            const eventEnvironmentInput = document.getElementById('eventEnvironment');
            const generateEventBtn = document.getElementById('generateEventBtn');
            const eventOutput = document.getElementById('eventOutput');

            const combatEnvironmentInput = document.getElementById('combatEnvironment');
            const generateCombatBtn = document.getElementById('generateCombatBtn');
            const combatOutput = document.getElementById('combatOutput');
            const monsterSelection = document.getElementById('monsterSelection');
            const monsterCheckboxContainer = document.getElementById('monsterCheckboxContainer');
            const startCombatBtn = document.getElementById('startCombatBtn');
            
            const totalXpInput = document.getElementById('totalXp');
            const calculateXpBtn = document.getElementById('calculateXpBtn');
            const xpOutput = document.getElementById('xpOutput');

            const turnOrderList = document.getElementById('turnOrder');
            const nextTurnBtn = document.getElementById('nextTurnBtn');
            const endCombatBtn = document.getElementById('endCombatBtn');
            const statBlockOutput = document.getElementById('statBlockOutput');
            
            const partyList = document.getElementById('partyList');
            const partyEmptyMsg = document.getElementById('party-empty-msg');
            
            const charNameInput = document.getElementById('charName');
            const charClassInput = document.getElementById('charClass');
            const charNotesInput = document.getElementById('charNotes');
            const saveCharBtn = document.getElementById('saveCharBtn');
            const savedCharsContainer = document.getElementById('savedCharsContainer');

            const diceButtonsContainer = document.getElementById('dice-buttons');
            const diceTotalEl = document.getElementById('diceTotal');
            const diceBreakdownEl = document.getElementById('diceBreakdown');
            const rollLogEl = document.getElementById('rollLog');
            
            const mapPromptInput = document.getElementById('mapPrompt');
            const generateMapImageBtn = document.getElementById('generateMapImageBtn');
            const mapActions = document.getElementById('mapActions');
            const saveMapBtn = document.getElementById('saveMapBtn');
            const downloadMapBtn = document.getElementById('downloadMapBtn');
            const mapBoard = document.getElementById('map-board');
            const mapImageOutput = document.getElementById('mapImageOutput');
            const mapGrid = document.getElementById('map-grid');
            const mapTokenContainer = document.getElementById('map-token-container');
            const mapToggleGrid = document.getElementById('map-toggle-grid');
            const mapToggleTokens = document.getElementById('map-toggle-tokens');
            const mapLibraryContainer = document.getElementById('mapLibraryContainer');
            const mapBreadcrumbs = document.getElementById('mapBreadcrumbs');
            const newFolderBtn = document.getElementById('newFolderBtn');
            
            const combatMapBoard = document.getElementById('combat-map-board');
            const combatMapImage = document.getElementById('combat-map-image');
            const combatMapGrid = document.getElementById('combat-map-grid');
            const combatTokenContainer = document.getElementById('combat-token-container');
            const combatToggleGrid = document.getElementById('combat-toggle-grid');
            const combatToggleTokens = document.getElementById('combat-toggle-tokens');

            const combatSceneModal = document.getElementById('combatSceneModal');
            const combatScenePrompt = document.getElementById('combatScenePrompt');
            const generateCombatMapBtn = document.getElementById('generateCombatMapBtn');
            const cancelCombatMapBtn = document.getElementById('cancelCombatMapBtn');
            const tokenTooltip = document.getElementById('tokenTooltip');

            const subscriptionStatus = document.getElementById('subscription-status');
            const apiCallsContainer = document.getElementById('api-calls-container');
            const apiCallsRemaining = document.getElementById('api-calls-remaining');
            const subscribeBtn = document.getElementById('subscribe-btn');


            // --- SYSTEM PROMPT ---
            const systemPrompt = `You are an expert Dungeon Master assistant for D&D 5e. Use accurate rules from Dungeons & Dragons 5th Edition to generate content based on user prompts. Respond only with the requested generation (e.g., loot lists, shop inventories, events, encounters, or stat blocks) in markdown format for readability. Do not add extra commentary unless asked. Keep responses concise, balanced for the party's level and size, and flavorful.`;
            
            // --- CUSTOM MODAL LOGIC ---
            const showModal = (message, buttons = [{ text: 'OK', value: true, class: 'bg-blue-700 hover:bg-blue-600' }]) => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customModal');
                    const messageEl = document.getElementById('customModalMessage');
                    const buttonsEl = document.getElementById('customModalButtons');

                    messageEl.textContent = message;
                    buttonsEl.innerHTML = '';

                    buttons.forEach(btnInfo => {
                        const button = document.createElement('button');
                        button.textContent = btnInfo.text;
                        button.className = `btn font-title flex-grow py-2 rounded-md ${btnInfo.class || ''}`;
                        button.onclick = () => {
                            modal.style.display = 'none';
                            resolve(btnInfo.value);
                        };
                        buttonsEl.appendChild(button);
                    });

                    modal.style.display = 'flex';
                });
            };

            const showPromptModal = (message, defaultValue = '') => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('customPromptModal');
                    const messageEl = document.getElementById('customPromptMessage');
                    const inputEl = document.getElementById('customPromptInput');
                    const buttonsEl = document.getElementById('customPromptButtons');

                    messageEl.textContent = message;
                    inputEl.value = defaultValue;
                    buttonsEl.innerHTML = '';

                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'btn font-title flex-grow py-2 rounded-md bg-blue-700 hover:bg-blue-600';
                    
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.className = 'btn font-title flex-grow py-2 rounded-md bg-gray-600 hover:bg-gray-500';

                    const handleOk = () => {
                        modal.style.display = 'none';
                        resolve(inputEl.value);
                        inputEl.removeEventListener('keyup', handleKeyup);
                    };

                    const handleCancel = () => {
                        modal.style.display = 'none';
                        resolve(null);
                        inputEl.removeEventListener('keyup', handleKeyup);
                    };
                    
                    const handleKeyup = (event) => {
                        if (event.key === 'Enter') {
                            handleOk();
                        } else if (event.key === 'Escape') {
                            handleCancel();
                        }
                    };

                    okButton.onclick = handleOk;
                    cancelButton.onclick = handleCancel;
                    inputEl.addEventListener('keyup', handleKeyup);

                    buttonsEl.appendChild(okButton);
                    buttonsEl.appendChild(cancelButton);

                    modal.style.display = 'flex';
                    inputEl.focus();
                    inputEl.select();
                });
            };

             // --- AUTHENTICATION ---
             auth.onAuthStateChanged(newUser => {
                user = newUser;
                if (user) {
                    // User is signed in.
                    userName.textContent = user.displayName;
                    loginBtn.classList.add('hidden');
                    userInfo.classList.remove('hidden');
                    loadCharactersFromStorage();
                    loadMapsFromStorage();
                    checkSubscription();
                } else {
                    // User is signed out.
                    userName.textContent = '';
                    loginBtn.classList.remove('hidden');
                    userInfo.classList.add('hidden');
                    subscriptionActive = false;
                    apiCalls = 10;
                    updateAccountUI();
                    loadCharactersFromStorage(); // Load from localStorage
                    loadMapsFromStorage(); // Load from localStorage
                }
            });

            loginBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Login failed:", error);
                });
            });

            logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });

            // --- SUBSCRIPTION & API LIMIT ---
            const checkSubscription = async () => {
                if (!user) return;
                // THIS IS A PLACEHOLDER: In a real app, you would check a database (like Firestore) 
                // to see if the user has an active subscription.
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists && doc.data().subscriptionActive) {
                    subscriptionActive = true;
                } else {
                    subscriptionActive = false;
                    apiCalls = (doc.exists && doc.data().apiCalls !== undefined) ? doc.data().apiCalls : 10;
                }
                updateAccountUI();
            };

            subscribeBtn.addEventListener('click', async () => {
                if (!user) {
                    showModal("Please log in to subscribe.");
                    return;
                }
                // THIS IS A PLACEHOLDER: In a real app, this would trigger a payment flow (e.g., Stripe, PayPal).
                // After successful payment, you'd update their status in your database.
                await db.collection('users').doc(user.uid).set({ subscriptionActive: true }, { merge: true });
                subscriptionActive = true;
                updateAccountUI();
                showModal("Congratulations! You are now a premium member with unlimited generations.");
            });

            const updateAccountUI = () => {
                if (subscriptionActive) {
                    subscriptionStatus.textContent = "Premium Tier";
                    apiCallsContainer.classList.add('hidden');
                } else {
                    subscriptionStatus.textContent = "Free Tier";
                    apiCallsContainer.classList.remove('hidden');
                    apiCallsRemaining.textContent = apiCalls;
                }
            };
            

            // --- TAB SWITCHING LOGIC ---
            const switchTab = (activeTabKey) => {
                Object.values(mainContent).forEach(c => c.classList.add('hidden'));
                Object.values(TABS).forEach(t => t.classList.remove('tab-btn-active'));
                
                mainContent[activeTabKey].classList.remove('hidden');
                TABS[activeTabKey].classList.add('tab-btn-active');
            };
            
            Object.keys(TABS).forEach(key => {
                TABS[key].addEventListener('click', () => switchTab(key));
            });
            
            // --- TOKEN & MAP LOGIC ---
            const renderTokens = (container, showPlayers, showEnemies) => {
                container.innerHTML = '';
                tokens.forEach(token => {
                    if ((token.type === 'player' && showPlayers) || (token.type === 'enemy' && showEnemies)) {
                        token.element.style.left = `${token.x}%`;
                        token.element.style.top = `${token.y}%`;
                        container.appendChild(token.element);
                    }
                });
            };

            const createToken = (id, type) => {
                const tokenElement = document.createElement('div');
                tokenElement.className = `token ${type}`;
                
                const playerSVG = `<svg viewBox="0 0 100 100"><circle cx="50" cy="30" r="20"/><path d="M15 95 C 15 70, 85 70, 85 95 Z"/></svg>`;
                const enemySVG = `<svg viewBox="0 0 100 100"><path d="M10 50 C10 10, 90 10, 90 50 C90 90, 60 90, 50 70 C40 90, 10 90, 10 50 Z M25 40 a5,5 0 1,1 -10,0 a5,5 0 1,1 10,0 M75 40 a5,5 0 1,1 -10,0 a5,5 0 1,1 10,0"/></svg>`;
                tokenElement.innerHTML = type === 'player' ? playerSVG : enemySVG;

                const gridSize = 5;
                const tokenSize = 4;
                const offset = (gridSize - tokenSize) / 2;
                const gridX = Math.floor(Math.random() * 20);
                const gridY = Math.floor(Math.random() * 20);
                const x = (gridX * gridSize) + offset;
                const y = (gridY * gridSize) + offset;

                const token = { id, x, y, type, element: tokenElement };

                tokenElement.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    activeToken = token;
                    tokenElement.classList.add('dragging');
                    offsetX = e.clientX - tokenElement.getBoundingClientRect().left;
                    offsetY = e.clientY - tokenElement.getBoundingClientRect().top;
                });
                
                tokenElement.addEventListener('mouseover', (e) => {
                    tokenTooltip.textContent = token.id;
                    tokenTooltip.classList.remove('hidden');
                    tokenTooltip.classList.add('opacity-100');
                    tokenTooltip.style.left = `${e.clientX + 15}px`;
                    tokenTooltip.style.top = `${e.clientY}px`;
                });
                
                tokenElement.addEventListener('mouseout', () => {
                    tokenTooltip.classList.add('hidden');
                    tokenTooltip.classList.remove('opacity-100');
                });

                return token;
            };

            document.addEventListener('mousemove', (e) => {
                if (!activeToken) return;

                const board = activeToken.element.parentElement.parentElement;
                const boardRect = board.getBoundingClientRect();
                let x = e.clientX - boardRect.left - offsetX;
                let y = e.clientY - boardRect.top - offsetY;

                let xPercent = (x / boardRect.width) * 100;
                let yPercent = (y / boardRect.height) * 100;
                
                const gridSize = 5;
                const tokenSize = 4;
                const offset = (gridSize - tokenSize) / 2;
                const gridX = Math.floor(xPercent / gridSize);
                const gridY = Math.floor(yPercent / gridSize);
                const snappedX = (gridX * gridSize) + offset;
                const snappedY = (gridY * gridSize) + offset;

                activeToken.x = Math.max(offset, Math.min(snappedX, 100 - tokenSize - offset));
                activeToken.y = Math.max(offset, Math.min(snappedY, 100 - tokenSize - offset));


                activeToken.element.style.left = `${activeToken.x}%`;
                activeToken.element.style.top = `${activeToken.y}%`;
                
                tokenTooltip.style.left = `${e.clientX + 15}px`;
                tokenTooltip.style.top = `${e.clientY}px`;
            });

            document.addEventListener('mouseup', () => {
                if (activeToken) {
                    activeToken.element.classList.remove('dragging');
                    activeToken = null;
                }
            });
            
            mapToggleGrid.addEventListener('change', () => mapGrid.classList.toggle('hidden'));
            combatToggleGrid.addEventListener('change', () => combatMapGrid.classList.toggle('hidden'));
            
            mapToggleTokens.addEventListener('change', () => {
                renderTokens(mapTokenContainer, mapToggleTokens.checked, false);
            });

            combatToggleTokens.addEventListener('change', () => {
                 renderTokens(combatTokenContainer, combatToggleTokens.checked, combatToggleTokens.checked);
            });
            
            // --- MAP LIBRARY LOGIC ---
            const getCurrentFolder = () => {
                let current = mapLibrary;
                for (const folderName of currentMapPath) {
                    // Ensure the path exists, creating it if it doesn't (defensive coding)
                    if (!current.folders[folderName]) {
                        current.folders[folderName] = { folders: {}, maps: [] };
                    }
                    current = current.folders[folderName];
                }
                return current;
            };
            
            const renderMapLibrary = () => {
                const currentFolder = getCurrentFolder();
                mapLibraryContainer.innerHTML = '';

                mapBreadcrumbs.innerHTML = `<span class="breadcrumb-link" data-path-index="-1">Library</span>`;
                currentMapPath.forEach((folderName, index) => {
                    mapBreadcrumbs.innerHTML += ` / <span class="breadcrumb-link" data-path-index="${index}">${folderName}</span>`;
                });

                Object.keys(currentFolder.folders).sort().forEach(folderName => {
                    const folderItem = document.createElement('div');
                    folderItem.className = 'library-item folder-item p-2 rounded-md flex flex-col items-center justify-center';
                    folderItem.dataset.folderName = folderName;
                    folderItem.innerHTML = `
                        <svg class="w-16 h-16 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                        <p class="text-center font-bold truncate mt-2 w-full">${folderName}</p>
                    `;
                    mapLibraryContainer.appendChild(folderItem);
                });

                currentFolder.maps.forEach(map => {
                    const mapItem = document.createElement('div');
                    mapItem.className = 'library-item p-2 rounded-md space-y-2';
                    mapItem.innerHTML = `
                        <img src="${map.imageData}" class="w-full h-32 object-cover rounded-md" alt="${map.name}">
                        <p class="text-center font-bold truncate w-full">${map.name}</p>
                        <div class="flex gap-2">
                            <button data-id="${map.id}" class="load-map-btn btn flex-grow text-sm py-1 px-2 rounded">Load</button>
                            <button data-id="${map.id}" class="delete-map-btn btn flex-grow text-sm py-1 px-2 rounded bg-gray-600 hover:bg-gray-500">Del</button>
                        </div>
                    `;
                    mapLibraryContainer.appendChild(mapItem);
                });
            };
            
            mapBreadcrumbs.addEventListener('click', (e) => {
                if (e.target.classList.contains('breadcrumb-link')) {
                    const pathIndex = parseInt(e.target.dataset.pathIndex);
                    currentMapPath = currentMapPath.slice(0, pathIndex + 1);
                    renderMapLibrary();
                }
            });

            newFolderBtn.addEventListener('click', async () => {
                const folderName = await showPromptModal("Enter new folder name:");
                if (folderName && folderName.trim() !== "") {
                    const currentFolder = getCurrentFolder();
                    if (!currentFolder.folders[folderName]) {
                        currentFolder.folders[folderName] = { folders: {}, maps: [] };
                        await saveAndRenderMaps();
                    } else {
                        await showModal("A folder with this name already exists.");
                    }
                }
            });

            mapLibraryContainer.addEventListener('click', (e) => {
                const folderItem = e.target.closest('.folder-item');
                const loadBtn = e.target.closest('.load-map-btn');
                const deleteBtn = e.target.closest('.delete-map-btn');

                if (folderItem) {
                    currentMapPath.push(folderItem.dataset.folderName);
                    renderMapLibrary();
                } else if (loadBtn) {
                    loadMap(loadBtn.dataset.id);
                } else if (deleteBtn) {
                    deleteMap(deleteBtn.dataset.id);
                }
            });

            const loadMap = (mapId) => {
                // Search the entire library, not just the current folder, for the map
                let foundMap = null;
                const findMapRecursive = (folder) => {
                    if (foundMap) return;
                    const map = folder.maps.find(m => m.id === mapId);
                    if (map) {
                        foundMap = map;
                        return;
                    }
                    for (const subFolderName in folder.folders) {
                        findMapRecursive(folder.folders[subFolderName]);
                    }
                };
                findMapRecursive(mapLibrary);
                if (foundMap) {
                    mapImageOutput.src = foundMap.imageData;
                    mapActions.classList.remove('hidden');
                    currentMapData = foundMap;
                }
            };

            const deleteMap = async (mapId) => {
                const confirmed = await showModal(`Are you sure you want to delete this map?`, [
                    { text: 'Delete', value: true, class: 'bg-red-700 hover:bg-red-600' },
                    { text: 'Cancel', value: false, class: 'bg-gray-600 hover:bg-gray-500' }
                ]);
                if (confirmed) {
                    const removeMapRecursive = (folder) => {
                        const index = folder.maps.findIndex(m => m.id === mapId);
                        if (index > -1) {
                            folder.maps.splice(index, 1);
                            return true;
                        }
                        for (const subFolderName in folder.folders) {
                            if (removeMapRecursive(folder.folders[subFolderName])) return true;
                        }
                        return false;
                    };
                    removeMapRecursive(mapLibrary);
                    await saveAndRenderMaps();
                }
            };

            saveMapBtn.addEventListener('click', async () => {
                const name = await showPromptModal("Enter map name:");
                if (name && name.trim() !== "") {
                    const currentFolder = getCurrentFolder();
                    const mapId = Date.now().toString();
                    currentFolder.maps.push({ id: mapId, name, imageData: mapImageOutput.src });
                    await saveAndRenderMaps();
                }
            });

            downloadMapBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.href = mapImageOutput.src;
                link.download = 'generated_map.png';
                link.click();
            });

            generateMapImageBtn.addEventListener('click', async () => {
                const prompt = mapPromptInput.value;
                if (!prompt) return;

                const btn = generateMapImageBtn;
                btn.disabled = true;
                btn.innerHTML = '<div class="loader mx-auto"></div>';

                const base64Data = await generateImageAPI(prompt);
                if (base64Data) {
                    mapImageOutput.src = `data:image/png;base64,${base64Data}`;
                    mapActions.classList.remove('hidden');
                } else {
                    await showModal("Failed to generate map image.");
                }

                btn.disabled = false;
                btn.innerHTML = 'Generate Map Image';
            });

            const saveAndRenderMaps = async () => {
                try {
                    if (user) {
                        await db.collection('users').doc(user.uid).collection('data').doc('maps').set(mapLibrary);
                    } else {
                        localStorage.setItem('dmHelperMaps', JSON.stringify(mapLibrary));
                    }
                    renderMapLibrary();
                } catch (e) {
                    console.error("Failed to save maps:", e);
                    await showModal("Error: Could not save maps. Your browser's storage may be full.");
                }
            };

            const loadMapsFromStorage = async () => {
                try {
                    if (user) {
                        const doc = await db.collection('users').doc(user.uid).collection('data').doc('maps').get();
                        if (doc.exists) mapLibrary = doc.data(); else mapLibrary = { folders: {}, maps: [] };
                    } else {
                        const stored = localStorage.getItem('dmHelperMaps');
                        if (stored) mapLibrary = JSON.parse(stored);
                    }
                } catch(e) {
                    console.error("Failed to load maps from storage:", e);
                    mapLibrary = { folders: {}, maps: [] };
                }
                renderMapLibrary();
            };

            // --- DICE ROLLER ---
            const rollDice = (sides) => Math.floor(Math.random() * sides) + 1;

            const updateRollLog = () => {
                rollLogEl.innerHTML = '';
                rollHistory.slice(-10).reverse().forEach(roll => {
                    const li = document.createElement('li');
                    li.textContent = roll.quantity > 1 ? `${roll.quantity}D${roll.sides}: ${roll.total} (${roll.results.join(', ')})` : `D${roll.sides}: ${roll.total}`;
                    li.className = 'border-b border-gray-700 pb-1';
                    rollLogEl.appendChild(li);
                });
            };

            diceButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-die]');
                if (button) {
                    const sides = parseInt(button.dataset.die);
                    const qtyInput = document.getElementById(`qty-d${sides}`);
                    const quantity = parseInt(qtyInput.value) || 1;
                    let results = [];
                    let total = 0;
                    for(let i = 0; i < quantity; i++) {
                        const roll = rollDice(sides);
                        results.push(roll);
                        total += roll;
                    }
                    diceTotalEl.textContent = total;
                    diceBreakdownEl.textContent = quantity > 1 ? results.join(' + ') : '';
                    rollHistory.push({ sides, quantity, results, total });
                    updateRollLog();
                }
            });

            // --- TEXT GENERATION API ---
            const callGeminiAPI = async (prompt) => {
                if (!subscriptionActive && apiCalls <= 0) {
                    showModal("You have run out of free AI generations. Please subscribe for unlimited access.");
                    return "API limit reached.";
                }
                
                // IMPORTANT: Replace with your Gemini API Key
                const apiKey = "AIzaSyDKRFfQlTs4H33C7_ArQymSeGVlEPUxrZE"; 
                if (apiKey === "YOUR_GEMINI_API_KEY") {
                    console.error("Gemini API key is a placeholder. Please replace it.");
                    return "ERROR: Gemini API key not configured. Please see the comment in the script.";
                }
                
                // FIX: Corrected the model name in the API URL
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                    const result = await response.json();

                    if (!subscriptionActive) {
                        apiCalls--;
                        if(user) await db.collection('users').doc(user.uid).set({ apiCalls: apiCalls }, { merge: true });
                        updateAccountUI();
                    }

                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return "There was an error communicating with the AI.";
                }
            };

            // --- IMAGE GENERATION ---
            const generateImageAPI = async (prompt) => {
                const apiKey = "AIzaSyDKRFfQlTs4H33C7_ArQymSeGVlEPUxrZE";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                
                const stylePrompt = "A detailed top-down battle map for D&D, fantasy, digital painting, playable game asset, high fantasy cartography. The perspective is directly overhead, like a blueprint. IMPORTANT: The map must be empty and contain absolutely no creatures, people, characters, animals, or monsters. Only generate the environment and terrain.";
                const fullPrompt = `${stylePrompt} Scene: ${prompt}`;

                const payload = { instances: [{ prompt: fullPrompt }], parameters: { "sampleCount": 1 } };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`Image API call failed with status: ${response.status}`); }
                    const result = await response.json();
                    return result.predictions[0].bytesBase64Encoded;
                } catch (error) {
                    console.error("Error calling Image API:", error);
                    return null;
                }
            };
            
            generateMapImageBtn.addEventListener('click', async () => {
                const userPrompt = mapPromptInput.value || 'a generic dungeon room';
                mapImageOutput.src = '';
                const container = mapBoard;
                container.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
                
                const base64Data = await generateImageAPI(userPrompt);
                
                container.innerHTML = ''; 
                container.appendChild(mapImageOutput);
                container.appendChild(mapGrid);
                container.appendChild(mapTokenContainer);
                
                if (base64Data) {
                    mapImageOutput.src = `data:image/png;base64,${base64Data}`;
                    tokens = party.map(p => createToken(p.name, 'player'));
                    renderTokens(mapTokenContainer, mapToggleTokens.checked, false);
                } else {
                    container.innerHTML = '<p class="text-red-500">Failed to generate map image.</p>';
                }
            });

            // --- CHARACTER & PARTY LOGIC ---
            const saveCharactersAndParty = async () => {
                try {
                    if (user) {
                        await db.collection('users').doc(user.uid).collection('data').doc('characters').set(characters);
                        await db.collection('users').doc(user.uid).collection('data').doc('party').set({ party });
                    } else {
                        localStorage.setItem('dmHelperCharacters', JSON.stringify(characters));
                        localStorage.setItem('dmHelperParty', JSON.stringify(party));
                    }
                } catch (e) {
                     console.error("Failed to save characters:", e);
                    await showModal("Error: Could not save characters. Your browser's storage may be full.");
                }
            };

            const loadCharactersFromStorage = async () => {
                try {
                    if (user) {
                        const charsDoc = await db.collection('users').doc(user.uid).collection('data').doc('characters').get();
                        if (charsDoc.exists) characters = charsDoc.data(); else characters = {};
                        
                        const partyDoc = await db.collection('users').doc(user.uid).collection('data').doc('party').get();
                        if (partyDoc.exists) party = partyDoc.data().party; else party = [];
                    } else {
                        const storedChars = localStorage.getItem('dmHelperCharacters');
                        characters = storedChars ? JSON.parse(storedChars) : {};
                        const storedParty = localStorage.getItem('dmHelperParty');
                        party = storedParty ? JSON.parse(storedParty) : [];
                    }
                } catch(e) {
                    console.error("Failed to load characters from storage:", e);
                    characters = {};
                    party = [];
                }
                renderSavedCharacters();
                renderPartyList();
            };

            const renderSavedCharacters = () => {
                savedCharsContainer.innerHTML = '';
                Object.values(characters).forEach(char => {
                    const isPartyMember = party.some(p => p.name === char.name);
                    const charCard = document.createElement('div');
                    charCard.className = 'p-4 border border-gray-600 rounded mb-2 flex justify-between items-center';
                    charCard.innerHTML = `<div><p class="font-bold">${char.name} - ${char.class}</p><p class="text-sm text-gray-400">${char.notes.substring(0,40)}...</p></div>`;
                    
                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'flex gap-2';
                    const partyBtn = document.createElement('button');
                    partyBtn.textContent = isPartyMember ? 'Remove' : 'Add to Party';
                    partyBtn.className = `btn text-sm py-1 px-2 rounded ${isPartyMember ? 'bg-gray-600' : ''}`;
                    partyBtn.onclick = () => togglePartyMember(char);
                    
                    const loadBtn = document.createElement('button');
                    loadBtn.textContent = 'Load';
                    loadBtn.className = 'btn text-sm py-1 px-2 rounded';
                    loadBtn.onclick = () => { charNameInput.value = char.name; charClassInput.value = char.class; charNotesInput.value = char.notes; };

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'X';
                    deleteBtn.className = 'btn text-sm py-1 px-2 rounded';
                    deleteBtn.onclick = () => deleteCharacter(char.name);

                    btnGroup.appendChild(partyBtn); btnGroup.appendChild(loadBtn); btnGroup.appendChild(deleteBtn);
                    charCard.appendChild(btnGroup);
                    savedCharsContainer.appendChild(charCard);
                });
            };

            const renderPartyList = () => {
                partyList.innerHTML = '';
                if (party.length > 0) {
                    partyEmptyMsg.classList.add('hidden');
                    party.forEach(char => {
                        const li = document.createElement('li');
                        li.textContent = `${char.name} (${char.class})`;
                        partyList.appendChild(li);
                    });
                } else {
                    partyEmptyMsg.classList.remove('hidden');
                }
            };

            const togglePartyMember = async (char) => {
                const index = party.findIndex(p => p.name === char.name);
                if (index > -1) party.splice(index, 1); else party.push(char);
                await saveCharactersAndParty();
                renderSavedCharacters();
                renderPartyList();
            };

            const saveCharacter = async (charData) => {
                const name = charData.name.trim();
                if (!name) {
                    showModal("Character name cannot be empty.");
                    return;
                }
                characters[name] = charData;
                await saveCharactersAndParty();
                renderSavedCharacters();
                charNameInput.value = charClassInput.value = charNotesInput.value = '';
            };

            const deleteCharacter = async (name) => {
                const confirmed = await showModal(`Are you sure you want to delete ${name}?`, [
                    { text: 'Delete', value: true, class: 'bg-red-700 hover:bg-red-600' },
                    { text: 'Cancel', value: false, class: 'bg-gray-600 hover:bg-gray-500' }
                ]);
                if (confirmed) {
                    delete characters[name];
                    party = party.filter(p => p.name !== name);
                    await saveCharactersAndParty();
                    renderSavedCharacters();
                    renderPartyList();
                }
            };
            saveCharBtn.addEventListener('click', ()=>saveCharacter({name: charNameInput.value, class: charClassInput.value, notes: charNotesInput.value}));
            
            const getAveragePartyLevel = () => {
                if (party.length === 0) return 1;
                const totalLevels = party.reduce((sum, char) => sum + (parseInt(char.class.match(/\d+/)?.[0]) || 1), 0);
                return Math.max(1, Math.round(totalLevels / party.length));
            };
            
            const parseMarkdown = (text) => text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^- (.*?)(\n|$)/gm, '<li>$1</li>').replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');

            calculateXpBtn.addEventListener('click', () => {
                const totalXp = parseInt(totalXpInput.value);
                if (isNaN(totalXp) || totalXp <= 0) { xpOutput.textContent = "Please enter a valid total XP."; return; }
                if (party.length === 0) { xpOutput.textContent = "Add players to the party to distribute XP."; return; }
                const xpPerPlayer = Math.floor(totalXp / party.length);
                xpOutput.textContent = `Total XP: ${totalXp}\nParty Members: ${party.length}\n---\n` + party.map(p => `${p.name} receives ${xpPerPlayer} XP.`).join('\n');
            });

            // Helper to get party backstories summary for AI prompts
            const getPartyBackstoriesSummary = () => {
                if (party.length === 0) return '';
                const summaries = party.map(p => {
                    const backstoryMatch = p.notes.match(/Backstory\s*(.*)/s);
                    return backstoryMatch ? backstoryMatch[1].trim().substring(0, 100) : '';
                }).filter(s => s);
                return summaries.length > 0 ? ` Subtly incorporate themes from party backstories: ${summaries.join('; ')}.` : '';
            };

            generateLootBtn.addEventListener('click', async () => {
                const playerClass = lootPlayerClassInput.value || 'adventurer';
                const playerLevel = getAveragePartyLevel();
                lootOutput.innerHTML = '<div class="loader"></div>';
                const backstorySummary = getPartyBackstoriesSummary();
                const prompt = `Generate D&D 5e loot for a level ${playerLevel} ${playerClass}.${backstorySummary}`;
                const response = await callGeminiAPI(prompt);
                lootOutput.innerHTML = parseMarkdown(response);
            });

            generateShopBtn.addEventListener('click', async () => {
                const shopType = shopTypeSelect.value;
                shopOutput.innerHTML = '<div class="loader"></div>';
                const backstorySummary = getPartyBackstoriesSummary();
                const prompt = `Generate a D&D 5e inventory for a ${shopType} shop.${backstorySummary}`;
                const response = await callGeminiAPI(prompt);
                shopOutput.innerHTML = parseMarkdown(response);
            });

            generateEventBtn.addEventListener('click', async () => {
                const environment = eventEnvironmentInput.value || 'any';
                const level = getAveragePartyLevel();
                eventOutput.innerHTML = '<div class="loader"></div>';
                const backstorySummary = getPartyBackstoriesSummary();
                const prompt = `Generate a random, non-combat D&D event for a level ${level} party in a ${environment} environment.${backstorySummary}`;
                const response = await callGeminiAPI(prompt);
                eventOutput.innerHTML = parseMarkdown(response);
            });

            generateCombatBtn.addEventListener('click', async () => {
                const environment = combatEnvironmentInput.value || 'generic';
                const level = getAveragePartyLevel();
                if (party.length === 0) { combatOutput.textContent = "Please add characters to your party first."; return; }
                combatOutput.innerHTML = '<div class="loader"></div>';
                monsterSelection.classList.add('hidden');
                const backstorySummary = getPartyBackstoriesSummary();
                const prompt = `Generate a D&D 5e combat encounter for a party of ${party.length} level ${level} players in a ${environment} environment. List the enemies on one line at the end, like 'Enemies: 2x Goblin, 1x Hobgoblin'.${backstorySummary}`;
                const response = await callGeminiAPI(prompt);
                combatOutput.innerHTML = parseMarkdown(response);

                const enemyLine = response.split('\n').find(line => line.toLowerCase().startsWith("enemies:"));
                if (enemyLine) {
                    lastGeneratedEnemies = [];
                    monsterCheckboxContainer.innerHTML = '';
                    const enemyStr = enemyLine.replace(/enemies:/i, "").trim();
                    const enemyGroups = enemyStr.split(', ');
                    
                    enemyGroups.forEach(group => {
                        const parts = group.split('x ');
                        if (parts.length < 2) return; // Skip malformed entries
                        const count = parseInt(parts[0]);
                        const name = parts.slice(1).join('x ').trim();
                        if (isNaN(count) || !name) return; // Skip invalid entries

                        lastGeneratedEnemies.push({ name, count });

                        const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2';
                        label.innerHTML = `<input type="checkbox" data-name="${name}" data-count="${count}" class="input-field" checked> <span>${group}</span>`;
                        monsterCheckboxContainer.appendChild(label);
                    });
                    monsterSelection.classList.remove('hidden');
                }
            });

            startCombatBtn.addEventListener('click', () => {
                const environment = combatEnvironmentInput.value || 'the generated encounter setting';
                combatScenePrompt.value = `A battle map for the following encounter: ${combatOutput.innerText.split('\n')[0]}. The environment is a ${environment}.`;
                combatSceneModal.style.display = 'flex';
            });
            
            cancelCombatMapBtn.addEventListener('click', () => combatSceneModal.style.display = 'none');

            generateCombatMapBtn.addEventListener('click', async () => {
                const scenePrompt = combatScenePrompt.value;
                if (!scenePrompt) return;

                const btn = generateCombatMapBtn;
                btn.disabled = true;
                btn.innerHTML = '<div class="loader mx-auto"></div>';

                const base64Data = await generateImageAPI(scenePrompt);
                
                if (base64Data) {
                    initiateCombat(`data:image/png;base64,${base64Data}`);
                } else {
                    await showModal("Failed to generate combat map. Starting combat without a map.");
                    initiateCombat(null);
                }

                combatSceneModal.style.display = 'none';
                btn.disabled = false;
                btn.innerHTML = 'Generate Map & Start';
            });

            const initiateCombat = async (mapImageUrl) => {
                 turnOrder = party.map(p => ({ name: p.name, type: 'player'}));
                 tokens = party.map(p => createToken(p.name, 'player'));
                
                const selectedCheckboxes = monsterCheckboxContainer.querySelectorAll('input[type="checkbox"]:checked');
                const monsterTypesToFetch = new Set();
                
                selectedCheckboxes.forEach(box => {
                    const name = box.dataset.name;
                    const count = parseInt(box.dataset.count);
                    monsterTypesToFetch.add(name);
                    for(let i=0; i < count; i++) {
                        const enemyName = `${name} ${i + 1}`;
                        turnOrder.push({ name: enemyName, type: 'enemy', baseType: name });
                        tokens.push(createToken(enemyName, 'enemy'));
                    }
                });
                
                if (turnOrder.length === party.length) { 
                    showModal("No monsters selected for combat.");
                    return;
                }
                
                // Shuffle turn order
                for (let i = turnOrder.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [turnOrder[i], turnOrder[j]] = [turnOrder[j], turnOrder[i]];
                }


                TABS.combat.classList.remove('hidden');
                switchTab('combat');
                
                if (mapImageUrl) {
                    combatMapImage.src = mapImageUrl;
                } else {
                    combatMapImage.src = '';
                }
                renderTokens(combatTokenContainer, combatToggleTokens.checked, combatToggleTokens.checked);
                renderTurnOrder();

                for (const type of monsterTypesToFetch) {
                    if (!monsterStatBlocks[type]) {
                        const prompt = `Provide a D&D 5e stat block for a ${type}.`;
                        monsterStatBlocks[type] = await callGeminiAPI(prompt);
                    }
                }
                
                currentTurnIndex = -1;
                nextTurnBtn.click();
            };
            
            const renderTurnOrder = () => {
                turnOrderList.innerHTML = '';
                turnOrder.forEach((participant, index) => {
                    const li = document.createElement('li');
                    li.textContent = participant.name;
                    li.className = `p-2 rounded cursor-pointer ${participant.type === 'player' ? 'bg-blue-900' : 'bg-red-900'} border border-gray-600 flex justify-between items-center transition-transform duration-200`;
                    if (index === currentTurnIndex) li.classList.add('turn-active');
                    li.onclick = () => {
                        currentTurnIndex = index;
                        renderTurnOrder();
                        updateStatBlock();
                    };
                    turnOrderList.appendChild(li);
                });
            };

            const updateStatBlock = () => {
                statBlockOutput.innerHTML = '';
                if (currentTurnIndex === -1 || !turnOrder[currentTurnIndex]) return;

                const participant = turnOrder[currentTurnIndex];
                if (participant.type === 'enemy') {
                    const statBlock = monsterStatBlocks[participant.baseType];
                    if (statBlock) {
                        statBlockOutput.innerHTML = parseMarkdown(statBlock);
                    } else {
                        statBlockOutput.innerHTML = `<div class="loader mx-auto"></div>`;
                    }
                } else {
                    const player = party.find(p => p.name === participant.name);
                    if (player && player.notes) {
                        statBlockOutput.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold">${player.name}</h3><p>${player.class}</p><hr class="my-2 border-gray-600"><p>${player.notes.replace(/\n/g, '<br>')}</p></div>`;
                    } else if (player) {
                         statBlockOutput.innerHTML = `<div class="p-4"><h3 class="text-2xl font-bold">${player.name}</h3><p>${player.class}</p></div>`;
                    }
                }
            };
            
            nextTurnBtn.addEventListener('click', () => {
                if (turnOrder.length > 0) {
                    currentTurnIndex = (currentTurnIndex + 1) % turnOrder.length;
                    renderTurnOrder();
                    updateStatBlock();
                }
            });

            endCombatBtn.addEventListener('click', () => {
                TABS.combat.classList.add('hidden');
                switchTab('session');
                currentTurnIndex = -1;
                turnOrder = [];
                lastGeneratedEnemies = [];
                monsterStatBlocks = {};
                monsterSelection.classList.add('hidden');
                combatOutput.innerHTML = '';
                eventOutput.innerHTML = '';
                statBlockOutput.innerHTML = `Select a creature from the turn tracker or press 'Next Turn'.`;
            });
            
            // --- CHARACTER CREATOR OVERHAUL ---
            const dndData = {}; 
            let creatorNavSetupDone = false;
            
            const loadDnDData = () => {
                const skills = ["Acrobatics (Dex)", "Animal Handling (Wis)", "Arcana (Int)", "Athletics (Str)", "Deception (Cha)", "History (Int)", "Insight (Wis)", "Intimidation (Cha)", "Investigation (Int)", "Medicine (Wis)", "Nature (Int)", "Perception (Wis)", "Performance (Cha)", "Persuasion (Cha)", "Religion (Int)", "Sleight of Hand (Dex)", "Stealth (Dex)", "Survival (Wis)"];
                const languages = ["Common", "Dwarvish", "Elvish", "Giant", "Gnomish", "Goblin", "Halfling", "Orc", "Abyssal", "Celestial", "Draconic", "Deep Speech", "Infernal", "Primordial", "Sylvan", "Undercommon"];
                const feats = ["Alert", "Athlete", "Actor", "Charger", "Crossbow Expert", "Defensive Duelist", "Dual Wielder", "Dungeon Delver", "Durable", "Elemental Adept", "Grappler", "Great Weapon Master", "Healer", "Heavily Armored", "Heavy Armor Master", "Inspiring Leader", "Keen Mind", "Lightly Armored", "Linguist", "Lucky", "Mage Slayer", "Magic Initiate", "Martial Adept", "Medium Armor Master", "Mobile", "Mounted Combatant", "Observant", "Polearm Master", "Resilient", "Ritual Caster", "Savage Attacker", "Sentinel", "Sharpshooter", "Shield Master", "Skilled", "Skulker", "Spell Sniper", "Tavern Brawler", "Tough", "War Caster", "Weapon Master"];

                Object.assign(dndData, {
                    alignments: ["Lawful Good", "Neutral Good", "Chaotic Good", "Lawful Neutral", "True Neutral", "Chaotic Neutral", "Lawful Evil", "Neutral Evil", "Chaotic Evil"],
                    skills: skills,
                    languages: languages,
                    feats: feats,
                    races: {
                        "Dwarf": {
                            description: "Bold and hardy, dwarves are known as skilled warriors, miners, and workers of stone and metal.",
                            subraces: [ { name: "Hill Dwarf", ability_score_increase: "Wis+1", traits: [{ name: "Dwarven Toughness", desc: "Your hit point maximum increases by 1, and it increases by 1 every time you gain a level." }] }, { name: "Mountain Dwarf", ability_score_increase: "Str+2", traits: [{ name: "Dwarven Armor Training", desc: "You have proficiency with light and medium armor." }] } ],
                            ability_score_increase: "Con+2", speed: 25, size: "Medium", languages: "You can speak, read, and write Common and Dwarvish.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Dwarven Resilience", desc: "Advantage on saving throws against poison, and resistance against poison damage." }, { name: "Dwarven Combat Training", desc: "Proficiency with the battleaxe, handaxe, light hammer, and warhammer." }, { name: "Tool Proficiency", desc: "Proficiency with smith's tools, brewer's supplies, or mason's tools." }, { name: "Stonecunning", desc: "Double proficiency bonus on Intelligence (History) checks related to the origin of stonework." } ]
                        },
                        "Elf": {
                            description: "Elves are a magical people of otherworldly grace, living in the world but not entirely part of it.",
                            subraces: [ { name: "High Elf", ability_score_increase: "Int+1", traits: [{ name: "Elf Weapon Training", desc: "Proficiency with longsword, shortsword, shortbow, and longbow." }, { name: "Cantrip", desc: "You know one cantrip of your choice from the wizard spell list. Intelligence is your spellcasting ability for it." }, { name: "Extra Language", desc: "You can speak, read, and write one extra language." }] }, { name: "Wood Elf", ability_score_increase: "Wis+1", traits: [{ name: "Elf Weapon Training", desc: "Proficiency with longsword, shortsword, shortbow, and longbow." }, { name: "Fleet of Foot", desc: "Your base walking speed increases to 35 feet." }, { name: "Mask of the Wild", desc: "You can attempt to hide even when you are only lightly obscured." }] } ],
                            ability_score_increase: "Dex+2", speed: 30, size: "Medium", languages: "You can speak, read, and write Common and Elvish.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Keen Senses", desc: "Proficiency in the Perception skill." }, { name: "Fey Ancestry", desc: "Advantage on saving throws against being charmed, and magic can't put you to sleep." }, { name: "Trance", desc: "Meditate for 4 hours for the same benefit as 8 hours of sleep." } ]
                        },
                        "Halfling": {
                            description: "The comforts of home are the goals of most halflings' lives: a place to settle in peace and quiet, far from marauding monsters and clashing armies.",
                            subraces: [ { name: "Lightfoot", ability_score_increase: "Cha+1", traits: [{ name: "Naturally Stealthy", desc: "You can attempt to hide even when you are obscured only by a creature that is at least one size larger than you." }] }, { name: "Stout", ability_score_increase: "Con+1", traits: [{ name: "Stout Resilience", desc: "You have advantage on saving throws against poison, and you have resistance against poison damage." }] } ],
                            ability_score_increase: "Dex+2", speed: 25, size: "Small", languages: "You can speak, read, and write Common and Halfling.",
                            traits: [ { name: "Lucky", desc: "When you roll a 1 on an attack roll, ability check, or saving throw, you can reroll the die and must use the new roll." }, { name: "Brave", desc: "Advantage on saving throws against being frightened." }, { name: "Halfling Nimbleness", desc: "You can move through the space of any creature that is of a size larger than yours." } ]
                        },
                        "Human": {
                            description: "Humans are the most adaptable and ambitious people among the common races. Whatever drives them, humans are the innovators, the achievers, and the pioneers of the worlds.",
                            subraces: [], ability_score_increase: "All+1", speed: 30, size: "Medium", languages: "You can speak, read, and write Common and one extra language of your choice.", traits: []
                        },
                        "Dragonborn": {
                            description: "Born of dragons, as their name proclaims, dragonborn walk proudly through a world that greets them with fearful incomprehension.",
                            subraces: [], ability_score_increase: "Str+2, Cha+1", speed: 30, size: "Medium", languages: "You can speak, read, and write Common and Draconic.",
                            traits: [ { name: "Draconic Ancestry", desc: "Choose a dragon type. Your breath weapon and damage resistance are determined by it." }, { name: "Breath Weapon", desc: "Use an action to exhale destructive energy. The damage and save type are based on your ancestry." }, { name: "Damage Resistance", desc: "You have resistance to the damage type associated with your draconic ancestry." } ]
                        },
                        "Gnome": {
                            description: "A gnome's energy and enthusiasm for living shines through every inch of his or her tiny body.",
                            subraces: [ { name: "Rock Gnome", ability_score_increase: "Con+1", traits: [{ name: "Artificer's Lore", desc: "Double proficiency on History checks related to magic, alchemical, or technological items." }, { name: "Tinker", desc: "Create a Tiny clockwork device." }] } ],
                            ability_score_increase: "Int+2", speed: 25, size: "Small", languages: "You can speak, read, and write Common and Gnomish.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Gnome Cunning", desc: "Advantage on all Intelligence, Wisdom, and Charisma saving throws against magic." } ]
                        },
                        "Half-Elf": {
                            description: "Half-elves combine what some say are the best qualities of their elf and human parents.",
                            subraces: [], ability_score_increase: "Cha+2, two others +1", speed: 30, size: "Medium", languages: "You can speak, read, and write Common, Elvish, and one extra language of your choice.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Fey Ancestry", desc: "Advantage on saving throws against being charmed, and magic can't put you to sleep." }, { name: "Skill Versatility", desc: "Gain proficiency in two skills of your choice." } ]
                        },
                        "Half-Orc": {
                            description: "Whether united under the leadership of a powerful warlock or having fought their way out of servitude, half-orcs must be strong to survive.",
                            subraces: [], ability_score_increase: "Str+2, Con+1", speed: 30, size: "Medium", languages: "You can speak, read, and write Common and Orc.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Menacing", desc: "Proficiency in the Intimidation skill." }, { name: "Relentless Endurance", desc: "When reduced to 0 HP but not killed, you can drop to 1 HP instead (once per long rest)." }, { name: "Savage Attacks", desc: "On a critical hit with a melee weapon, roll one of the weapon's damage dice one additional time." } ]
                        },
                        "Tiefling": {
                            description: "To be greeted with stares and whispers, to suffer violence and insult on the street, to see mistrust and fear in every eye: this is the lot of the tiefling.",
                            subraces: [], ability_score_increase: "Int+1, Cha+2", speed: 30, size: "Medium", languages: "You can speak, read, and write Common and Infernal.",
                            traits: [ { name: "Darkvision", desc: "See in dim light within 60 feet as if it were bright light, and in darkness as if it were dim light." }, { name: "Hellish Resistance", desc: "You have resistance to fire damage." }, { name: "Infernal Legacy", desc: "You know the thaumaturgy cantrip. At 3rd level, you can cast hellish rebuke once per long rest. At 5th, you can cast darkness once per long rest." } ]
                        }
                    },
                    classes: {
                        "Barbarian": { description: "A fierce warrior who can enter a battle rage.", hit_die: 12, primary_ability: "Strength", saves: ["Strength", "Constitution"], proficiencies: { armor: ["Light armor", "medium armor", "shields"], weapons: ["Simple weapons", "martial weapons"], skills: { count: 2, options: ["Animal Handling", "Athletics", "Intimidation", "Nature", "Perception", "Survival"] } }, equipment_choices: [ { options: ["a greataxe", "any martial melee weapon"] }, { options: ["two handaxes", "any simple weapon"] }, { fixed: "An explorer's pack and four javelins" } ], features: [{ name: "Rage", desc: "As a bonus action, enter a rage for 1 min. Gain advantage on Str checks/saves, +2 damage on Str melee attacks, and resistance to bludgeoning, piercing, and slashing damage." }, { name: "Unarmored Defense", desc: "While not wearing armor, your AC is 10 + Dex modifier + Con modifier." }], subclass_level: 3, subclasses: ["Path of the Berserker", "Path of the Totem Warrior"], spellcasting: false },
                        "Bard": { description: "An inspiring magician whose power echoes the music of creation.", hit_die: 8, primary_ability: "Charisma", saves: ["Dexterity", "Charisma"], proficiencies: { armor: ["Light armor"], weapons: ["Simple weapons", "hand crossbows", "longswords", "rapiers", "shortswords"], tools: ["Three musical instruments of your choice"], skills: { count: 3, options: skills } }, equipment_choices: [ { options: ["a rapier", "a longsword", "any simple weapon"] }, { options: ["a diplomat's pack", "an entertainer's pack"] }, { options: ["a lute", "any other musical instrument"] }, { fixed: "Leather armor and a dagger" } ], features: [{ name: "Bardic Inspiration (d6)", desc: "As a bonus action, give one creature a d6 they can add to one ability check, attack roll, or saving throw in the next 10 minutes. Usable Cha mod times per long rest." }, { name: "Spellcasting", desc: "You can cast bard spells. You know 4 spells and 2 cantrips at level 1." }], subclass_level: 3, subclasses: ["College of Lore", "College of Valor"], spellcasting: true },
                        "Cleric": { description: "A priestly champion who wields divine magic.", hit_die: 8, primary_ability: "Wisdom", saves: ["Wisdom", "Charisma"], proficiencies: { armor: ["Light armor", "medium armor", "shields"], weapons: ["Simple weapons"], skills: { count: 2, options: ["History", "Insight", "Medicine", "Persuasion", "Religion"] } }, equipment_choices: [ { options: ["a mace", "a warhammer (if proficient)"] }, { options: ["scale mail", "leather armor", "chain mail (if proficient)"] }, { options: ["a light crossbow and 20 bolts", "any simple weapon"] }, { options: ["a priest's pack", "an explorer's pack"] }, { fixed: "A shield and a holy symbol" } ], features: [{ name: "Spellcasting", desc: "You can cast cleric spells. You know 3 cantrips and prepare a number of spells equal to your Wis mod + cleric level." }, { name: "Divine Domain", desc: "Choose a domain (e.g., Life, Knowledge) that grants you spells and features." }], subclass_level: 1, subclasses: ["Life Domain", "Knowledge Domain", "Light Domain", "Nature Domain", "Tempest Domain", "Trickery Domain", "War Domain"], spellcasting: true },
                        "Druid": { description: "A priest of the Old Faith, wielding the powers of nature.", hit_die: 8, primary_ability: "Wisdom", saves: ["Intelligence", "Wisdom"], proficiencies: { armor: ["Light armor", "medium armor", "shields (non-metal)"], weapons: ["Clubs", "daggers", "darts", "javelins", "maces", "quarterstaffs", "scimitars", "sickles", "slings", "spears"], tools: ["Herbalism kit"], skills: { count: 2, options: ["Arcana", "Animal Handling", "Insight", "Medicine", "Nature", "Perception", "Religion", "Survival"] } }, equipment_choices: [ { options: ["a wooden shield", "any simple weapon"] }, { options: ["a scimitar", "any simple melee weapon"] }, { fixed: "Leather armor, an explorer's pack, and a druidic focus" } ], features: [{ name: "Druidic", desc: "You know the secret language of druids." }, { name: "Spellcasting", desc: "You can cast druid spells. You know 2 cantrips and prepare a number of spells equal to your Wis mod + druid level." }], subclass_level: 2, subclasses: ["Circle of the Land", "Circle of the Moon"], spellcasting: true },
                        "Fighter": { description: "A master of martial combat.", hit_die: 10, primary_ability: "Strength or Dexterity", saves: ["Strength", "Constitution"], proficiencies: { armor: ["All armor", "shields"], weapons: ["Simple weapons", "martial weapons"], skills: { count: 2, options: ["Acrobatics", "Animal Handling", "Athletics", "History", "Insight", "Intimidation", "Perception", "Survival"] } }, equipment_choices: [ { options: ["chain mail", "leather armor, longbow, and 20 arrows"] }, { options: ["a martial weapon and a shield", "two martial weapons"] }, { options: ["a light crossbow and 20 bolts", "two handaxes"] }, { options: ["a dungeoneer's pack", "an explorer's pack"] } ], features: [{ name: "Fighting Style", desc: "Choose a fighting style, such as Archery, Dueling, or Great Weapon Fighting." }, { name: "Second Wind", desc: "Once per short rest, use a bonus action to regain 1d10 + fighter level HP." }], subclass_level: 3, subclasses: ["Champion", "Battle Master", "Eldritch Knight"], spellcasting: false },
                        "Monk": { description: "A master of martial arts, harnessing the power of the body in pursuit of physical and spiritual perfection.", hit_die: 8, primary_ability: "Dexterity & Wisdom", saves: ["Strength", "Dexterity"], proficiencies: { weapons: ["Simple weapons", "shortswords"], tools: ["One type of artisan's tools or one musical instrument"], skills: { count: 2, options: ["Acrobatics", "Athletics", "History", "Insight", "Religion", "Stealth"] } }, equipment_choices: [ { options: ["a shortsword", "any simple weapon"] }, { options: ["a dungeoneer's pack", "an explorer's pack"] }, { fixed: "10 darts" } ], features: [{ name: "Unarmored Defense", desc: "While wearing no armor and no shield, your AC is 10 + Dex mod + Wis mod." }, { name: "Martial Arts", desc: "You can use Dexterity instead of Strength for attacks and damage with unarmed strikes and monk weapons. You can make one unarmed strike as a bonus action after attacking." }], subclass_level: 3, subclasses: ["Way of the Open Hand", "Way of Shadow", "Way of the Four Elements"], spellcasting: false },
                        "Paladin": { description: "A holy warrior bound to a sacred oath.", hit_die: 10, primary_ability: "Strength & Charisma", saves: ["Wisdom", "Charisma"], proficiencies: { armor: ["All armor", "shields"], weapons: ["Simple weapons", "martial weapons"], skills: { count: 2, options: ["Athletics", "Insight", "Intimidation", "Medicine", "Persuasion", "Religion"] } }, equipment_choices: [ { options: ["a martial weapon and a shield", "two martial weapons"] }, { options: ["five javelins", "any simple melee weapon"] }, { options: ["a priest's pack", "an explorer's pack"] }, { fixed: "Chain mail and a holy symbol" } ], features: [{ name: "Divine Sense", desc: "As an action, you can detect strong evil or good, or the presence of any celestial, fiend, or undead within 60 feet. Usable 1 + Cha mod times per long rest." }, { name: "Lay on Hands", desc: "You have a pool of healing power equal to your paladin level x 5. As an action, you can touch a creature and draw power from the pool to restore a number of hit points up to the maximum amount remaining in your pool." }], subclass_level: 3, subclasses: ["Oath of Devotion", "Oath of the Ancients", "Oath of Vengeance"], spellcasting: true },
                        "Ranger": { description: "A warrior who uses martial prowess and nature magic to combat threats on the edges of civilization.", hit_die: 10, primary_ability: "Dexterity & Wisdom", saves: ["Strength", "Dexterity"], proficiencies: { armor: ["Light armor", "medium armor", "shields"], weapons: ["Simple weapons", "martial weapons"], skills: { count: 3, options: ["Animal Handling", "Athletics", "Insight", "Investigation", "Nature", "Perception", "Stealth", "Survival"] } }, equipment_choices: [ { options: ["scale mail", "leather armor"] }, { options: ["two shortswords", "two simple melee weapons"] }, { options: ["a dungeoneer's pack", "an explorer's pack"] }, { fixed: "A longbow and a quiver of 20 arrows" } ], features: [{ name: "Favored Enemy", desc: "You have significant experience studying, tracking, hunting, and even talking to a certain type of enemy. Choose a type of favored enemy: aberrations, beasts, celestials, constructs, dragons, elementals, fey, fiends, giants, monstrosities, oozes, plants, or undead. You have advantage on Wisdom (Survival) checks to track your favored enemies, as well as on Intelligence checks to recall information about them." }, { name: "Natural Explorer", desc: "You are particularly familiar with one type of natural environment and are adept at traveling and surviving in such regions. Choose one type of favored terrain: arctic, coast, desert, forest, grassland, mountain, swamp, or the Underdark. When you make an Intelligence or Wisdom check related to your favored terrain, your proficiency bonus is doubled if you are using a skill that you’re proficient in." }], subclass_level: 3, subclasses: ["Hunter", "Beast Master"], spellcasting: true },
                        "Rogue": { description: "A scoundrel who uses stealth and trickery to overcome obstacles and enemies.", hit_die: 8, primary_ability: "Dexterity", saves: ["Dexterity", "Intelligence"], proficiencies: { armor: ["Light armor"], weapons: ["Simple weapons", "hand crossbows", "longswords", "rapiers", "shortswords"], tools: ["Thieves' tools"], skills: { count: 4, options: ["Acrobatics", "Athletics", "Deception", "Insight", "Intimidation", "Investigation", "Perception", "Performance", "Persuasion", "Sleight of Hand", "Stealth"] } }, equipment_choices: [ { options: ["a rapier", "a shortsword"] }, { options: ["a shortbow and quiver of 20 arrows", "a shortsword"] }, { options: ["a burglar's pack", "a dungeoneer's pack", "an explorer's pack"] }, { fixed: "Leather armor, two daggers, and thieves' tools" } ], features: [{ name: "Expertise", desc: "Choose two of your skill proficiencies, or one of your skill proficiencies and your proficiency with thieves’ tools. Your proficiency bonus is doubled for any ability check you make that uses either of the chosen proficiencies." }, { name: "Sneak Attack", desc: "Once per turn, you can deal an extra 1d6 damage to one creature you hit with an attack if you have advantage on the attack roll. The attack must use a finesse or a ranged weapon." }, { name: "Thieves' Cant", desc: "You know the secret mix of dialect, jargon, and code that allows you to hide messages in seemingly normal conversation." }], subclass_level: 3, subclasses: ["Thief", "Assassin", "Arcane Trickster"], spellcasting: false },
                        "Sorcerer": { description: "A spellcaster who draws on inherent magic from a gift or bloodline.", hit_die: 6, primary_ability: "Charisma", saves: ["Constitution", "Charisma"], proficiencies: { weapons: ["Daggers", "darts", "slings", "quarterstaffs", "light crossbows"], skills: { count: 2, options: ["Arcana", "Deception", "Insight", "Intimidation", "Persuasion", "Religion"] } }, equipment_choices: [ { options: ["a light crossbow and 20 bolts", "any simple weapon"] }, { options: ["a component pouch", "an arcane focus"] }, { options: ["a dungeoneer's pack", "an explorer's pack"] }, { fixed: "Two daggers" } ], features: [{ name: "Spellcasting", desc: "You can cast sorcerer spells. You know 4 spells and 4 cantrips at level 1." }, { name: "Sorcerous Origin", desc: "Choose a sorcerous origin, which describes the source of your innate magical power: Draconic Bloodline or Wild Magic." }], subclass_level: 1, subclasses: ["Draconic Bloodline", "Wild Magic"], spellcasting: true },
                        "Warlock": { description: "A wielder of magic that is derived from a bargain with an extraplanar entity.", hit_die: 8, primary_ability: "Charisma", saves: ["Wisdom", "Charisma"], proficiencies: { armor: ["Light armor"], weapons: ["Simple weapons"], skills: { count: 2, options: ["Arcana", "Deception", "History", "Intimidation", "Investigation", "Nature", "Religion"] } }, equipment_choices: [ { options: ["a light crossbow and 20 bolts", "any simple weapon"] }, { options: ["a component pouch", "an arcane focus"] }, { options: ["a scholar's pack", "a dungeoneer's pack"] }, { fixed: "Leather armor, any simple weapon, and two daggers" } ], features: [{ name: "Otherworldly Patron", desc: "Choose a patron: The Archfey, The Fiend, or The Great Old One." }, { name: "Pact Magic", desc: "Your arcane research and the magic bestowed on you by your patron have given you facility with spells. You know two cantrips and two 1st-level spells. You have one 1st-level spell slot, which you regain on a short or long rest." }], subclass_level: 1, subclasses: ["The Archfey", "The Fiend", "The Great Old One"], spellcasting: true },
                        "Wizard": { description: "A scholarly magic-user capable of manipulating the structures of reality.", hit_die: 6, primary_ability: "Intelligence", saves: ["Intelligence", "Wisdom"], proficiencies: { weapons: ["Daggers", "darts", "slings", "quarterstaffs", "light crossbows"], skills: { count: 2, options: ["Arcana", "History", "Insight", "Investigation", "Medicine", "Religion"] } }, equipment_choices: [ { options: ["a quarterstaff", "a dagger"] }, { options: ["a component pouch", "an arcane focus"] }, { options: ["a scholar's pack", "an explorer's pack"] }, { fixed: "A spellbook" } ], features: [{ name: "Spellcasting", desc: "You can cast wizard spells. You know 3 cantrips and have a spellbook containing six 1st-level spells." }, { name: "Arcane Recovery", desc: "Once per day when you finish a short rest, you can choose expended spell slots to recover. The spell slots can have a combined level that is equal to or less than half your wizard level (rounded up)." }], subclass_level: 2, subclasses: ["School of Abjuration", "School of Conjuration", "School of Divination", "School of Enchantment", "School of Evocation", "School of Illusion", "School of Necromancy", "School of Transmutation"], spellcasting: true }
                    },
                    backgrounds: {
                        "Acolyte": { skill_proficiencies: ["Insight", "Religion"], languages_choices: 2, equipment: "A holy symbol, a prayer book, 5 sticks of incense, vestments, common clothes, and 15 gp", feature: { name: "Shelter of the Faithful", desc: "You and your companions can receive free healing and care at a temple of your faith." }, personalityTraits: ["I idolize a particular hero of my faith.", "I see omens in every event.", "I quote sacred texts in almost every situation.", "I've spent so long in the temple that I have little practical experience with the outside world."], ideals: ["Tradition (Lawful)", "Charity (Good)", "Change (Chaotic)", "Power (Lawful)", "Faith (Lawful)", "Aspiration (Any)"], bonds: ["I would die to recover an ancient relic.", "I will get revenge on a corrupt temple hierarchy.", "I owe my life to the priest who took me in.", "I will do anything to protect the temple where I served."], flaws: ["I judge others harshly.", "I put too much trust in those who wield power within my temple.", "I am suspicious of strangers.", "I am inflexible in my thinking."] },
                        "Criminal": { skill_proficiencies: ["Deception", "Stealth"], tool_proficiencies: ["One type of gaming set", "Thieves' tools"], equipment: "A crowbar, dark common clothes with a hood, and 15 gp", feature: { name: "Criminal Contact", desc: "You have a reliable contact in the criminal underworld." }, personalityTraits: ["I always have a plan.", "I am always calm, no matter the situation.", "The first thing I do in a new place is note the locations of everything valuable.", "I would rather make a new friend than a new enemy."], ideals: ["Honor (Lawful)", "Freedom (Chaotic)", "Charity (Good)", "Greed (Evil)", "People (Neutral)", "Redemption (Good)"], bonds: ["I'm trying to pay off an old debt.", "My ill-gotten gains go to support my family.", "Something important was taken from me, and I aim to steal it back.", "Someone I loved died because of a mistake I made. That will never happen again."], flaws: ["When I see something valuable, I can't think about anything but stealing it.", "I have a 'tell' that reveals when I'm lying.", "I turn tail and run when things look bad.", "An innocent person is in prison for a crime I committed."] },
                        "Folk Hero": { skill_proficiencies: ["Animal Handling", "Survival"], tool_proficiencies: ["One type of artisan's tools", "Land vehicles"], equipment: "A set of artisan's tools, a shovel, an iron pot, common clothes, and 10 gp", feature: { name: "Rustic Hospitality", desc: "Common folk will welcome you and hide you from the law. They will not risk their lives for you." }, personalityTraits: ["I judge people by their actions, not their words.", "If someone is in trouble, I'm always ready to lend help.", "I have a strong sense of fair play and always try to find the most equitable solution to arguments.", "I'm confident in my own abilities and do what I can to instill confidence in others."], ideals: ["Respect (Good)", "Fairness (Lawful)", "Freedom (Chaotic)", "Might (Neutral)", "Sincerity (Neutral)", "Destiny (Any)"], bonds: ["I have a family, but I have no idea where they are. One day, I hope to see them again.", "I worked the land, I love the land, and I will protect the land.", "A proud noble once gave me a horrible beating, and I will take my revenge on any bully I encounter.", "My tools are symbols of my past life, and I carry them so that I will never forget my roots."], flaws: ["The tyrant who rules my land will stop at nothing to see me killed.", "I'm convinced of the significance of my destiny, and blind to my shortcomings and the risk of failure.", "The people who knew me when I was young know my shameful secret, so I can never go home again.", "I have a weakness for the vices of the city, especially hard drink."] },
                        "Noble": { skill_proficiencies: ["History", "Persuasion"], tool_proficiencies: ["One type of gaming set"], languages_choices: 1, equipment: "A set of fine clothes, a signet ring, a scroll of pedigree, and 25 gp", feature: { name: "Position of Privilege", desc: "You are welcome in high society, and people assume you have the right to be wherever you are." }, personalityTraits: ["My eloquent flattery makes everyone I talk to feel like the most wonderful and important person in the world.", "The common folk love me for my kindness and generosity.", "I take great pains to always look my best and follow the latest fashions.", "I don't like to get my hands dirty, and I won't be caught dead in unsuitable accommodations."], ideals: ["Respect (Good)", "Responsibility (Lawful)", "Independence (Chaotic)", "Power (Evil)", "Family (Any)", "Noble Obligation (Good)"], bonds: ["I will face any challenge to win the approval of my family.", "My house's alliance with another noble family must be sustained at all costs.", "The common folk must see me as a hero of the people.", "My loyalty to my sovereign is unwavering."], flaws: ["I secretly believe that everyone is beneath me.", "I hide a truly scandalous secret that could ruin my family forever.", "I too often hear veiled insults and threats in every word addressed to me, and I'm quick to anger.", "I have an insatiable desire for carnal pleasures."] },
                        "Sage": { skill_proficiencies: ["Arcana", "History"], languages_choices: 2, equipment: "A bottle of black ink, a quill, a small knife, a letter from a dead colleague, common clothes, and 10 gp", feature: { name: "Researcher", desc: "When you attempt to learn or recall a piece of lore, if you do not know that information, you often know where and from whom you can obtain it." }, personalityTraits: ["I use polysyllabic words that convey the impression of great erudition.", "I've read every book in the world's greatest libraries... or I like to boast that I have.", "I'm willing to listen to every side of an argument before I make my own judgment.", "I am horribly, horribly awkward in social situations."], ideals: ["Knowledge (Neutral)", "Beauty (Good)", "Logic (Lawful)", "No Limits (Chaotic)", "Power (Evil)", "Self-Improvement (Any)"], bonds: ["It is my duty to protect my students.", "I have an ancient text that holds terrible secrets that must not fall into the wrong hands.", "I work to preserve a library, university, scriptorium, or monastery.", "My life's work is a series of tomes related to a specific field of lore."], flaws: ["I am easily distracted by the promise of information.", "Most people scream and run when they see a demon. I stop and take notes on its anatomy.", "I speak without really thinking through my words, invariably insulting others.", "I can't keep a secret to save my life, or anyone else's."] },
                        "Soldier": { skill_proficiencies: ["Athletics", "Intimidation"], tool_proficiencies: ["One type of gaming set", "Land vehicles"], equipment: "An insignia of rank, a trophy taken from a fallen enemy, a set of bone dice or deck of cards, common clothes, and 10 gp", feature: { name: "Military Rank", desc: "Soldiers loyal to your former military organization still recognize your authority and influence." }, personalityTraits: ["I'm always polite and respectful.", "I'm haunted by memories of war. I can't get the images of violence out of my mind.", "I've lost too many friends, and I'm slow to make new ones.", "I'm full of inspiring and cautionary tales from my military experience relevant to almost every combat situation."], ideals: ["Greater Good (Good)", "Responsibility (Lawful)", "Independence (Chaotic)", "Might (Evil)", "Live and Let Live (Neutral)", "Nation (Any)"], bonds: ["I would still lay down my life for the people I served with.", "Someone saved my life on the battlefield. To this day, I will never leave a friend behind.", "My honor is my life.", "I'll never forget the crushing defeat my company suffered or the enemies who dealt it."], flaws: ["The monstrous enemy we faced in battle still leaves me quaking with fear.", "I have little respect for anyone who is not a proven warrior.", "I made a terrible mistake in battle that cost many lives, and I would do anything to keep that mistake secret.", "My hatred of my enemies is blind and unreasoning."] }
                    },
                    spells: {
                        "Bard": { cantrips: ["Blade Ward", "Dancing Lights", "Friends", "Light", "Mage Hand", "Mending", "Message", "Minor Illusion", "Prestidigitation", "True Strike", "Vicious Mockery"], level1: ["Animal Friendship", "Bane", "Charm Person", "Comprehend Languages", "Cure Wounds", "Detect Magic", "Disguise Self", "Faerie Fire", "Feather Fall", "Healing Word", "Heroism", "Identify", "Illusory Script", "Longstrider", "Silent Image", "Sleep", "Speak with Animals", "Tasha's Hideous Laughter", "Thunderwave", "Unseen Servant"] },
                        "Cleric": { cantrips: ["Guidance", "Light", "Mending", "Resistance", "Sacred Flame", "Spare the Dying", "Thaumaturgy"], level1: ["Bane", "Bless", "Command", "Create or Destroy Water", "Cure Wounds", "Detect Evil and Good", "Detect Magic", "Guiding Bolt", "Healing Word", "Inflict Wounds", "Protection from Evil and Good", "Sanctuary", "Shield of Faith"] },
                        "Druid": { cantrips: ["Druidcraft", "Guidance", "Mending", "Poison Spray", "Produce Flame", "Resistance", "Shillelagh"], level1: ["Animal Friendship", "Charm Person", "Create or Destroy Water", "Cure Wounds", "Detect Magic", "Entangle", "Faerie Fire", "Fog Cloud", "Goodberry", "Healing Word", "Jump", "Longstrider", "Speak with Animals", "Thunderwave"] },
                        "Paladin": { level1: ["Bless", "Command", "Cure Wounds", "Detect Evil and Good", "Detect Magic", "Divine Favor", "Heroism", "Protection from Evil and Good", "Shield of Faith", "Wrathful Smite"] },
                        "Ranger": { level1: ["Alarm", "Animal Friendship", "Cure Wounds", "Detect Magic", "Ensnaring Strike", "Fog Cloud", "Goodberry", "Hail of Thorns", "Hunter's Mark", "Jump", "Longstrider", "Speak with Animals"] },
                        "Sorcerer": { cantrips: ["Acid Splash", "Chill Touch", "Dancing Lights", "Fire Bolt", "Light", "Mage Hand", "Mending", "Message", "Minor Illusion", "Poison Spray", "Prestidigitation", "Ray of Frost", "Shocking Grasp", "True Strike"], level1: ["Burning Hands", "Charm Person", "Detect Magic", "Disguise Self", "Feather Fall", "Mage Armor", "Magic Missile", "Shield", "Silent Image", "Sleep", "Thunderwave"] },
                        "Warlock": { cantrips: ["Chill Touch", "Eldritch Blast", "Mage Hand", "Minor Illusion", "Poison Spray", "Prestidigitation", "True Strike"], level1: ["Charm Person", "Comprehend Languages", "Expeditious Retreat", "Hellish Rebuke", "Hex", "Illusory Script", "Protection from Evil and Good", "Unseen Servant"] },
                        "Wizard": { cantrips: ["Acid Splash", "Chill Touch", "Dancing Lights", "Fire Bolt", "Light", "Mage Hand", "Mending", "Message", "Minor Illusion", "Poison Spray", "Prestidigitation", "Ray of Frost", "Shocking Grasp", "True Strike"], level1: ["Alarm", "Burning Hands", "Charm Person", "Comprehend Languages", "Detect Magic", "Disguise Self", "Feather Fall", "Find Familiar", "Identify", "Mage Armor", "Magic Missile", "Shield", "Silent Image", "Sleep", "Thunderwave", "Unseen Servant"] }
                    }
                });
            };

            const goToStep = (step) => {
                document.querySelectorAll('.creator-step').forEach(s => s.classList.remove('active'));
                const nextStepEl = document.getElementById(`creator-step-${step}`);
                if(nextStepEl) {
                    nextStepEl.classList.add('active');
                }
            };

            const setupCreatorNav = () => {
                if (creatorNavSetupDone) return;

                document.getElementById('creator-next-1').addEventListener('click', () => { 
                    creatorData.race = document.getElementById('race-select').value; 
                    creatorData.subrace = document.getElementById('subrace-select').value || null;
                    goToStep(2); 
                });
                document.getElementById('creator-prev-2').addEventListener('click', () => goToStep(1));
                document.getElementById('creator-next-2').addEventListener('click', () => { 
                    creatorData.class = document.getElementById('class-select').value;
                    creatorData.subclass = document.getElementById('subclass-select').value || null;
                    goToStep(3);
                });
                document.getElementById('creator-prev-3').addEventListener('click', () => goToStep(2));
                document.getElementById('creator-next-3').addEventListener('click', () => {
                     if (document.getElementById('points-remaining').innerText !== '0') {
                        showModal("You must spend all 27 ability score points to continue.");
                        return;
                    }
                    goToStep(4)
                });
                document.getElementById('creator-prev-4').addEventListener('click', () => goToStep(3));
                document.getElementById('creator-next-4').addEventListener('click', () => { 
                    creatorData.background = document.getElementById('background-select').value;
                    populatePersonalityTraits();
                    populateLanguages();
                    goToStep(5);
                });
                document.getElementById('creator-prev-5').addEventListener('click', () => goToStep(4));
                document.getElementById('creator-next-5').addEventListener('click', () => {
                    creatorData.name = document.getElementById('creator-char-name').value;
                    if (!creatorData.name) {
                        showModal("Please enter a character name.");
                        return;
                    }
                    creatorData.alignment = document.getElementById('alignment-select').value;
                    creatorData.age = document.getElementById('age-input').value;
                    creatorData.height = document.getElementById('height-input').value;
                    creatorData.weight = document.getElementById('weight-input').value;
                    creatorData.eyes = document.getElementById('eyes-input').value;
                    creatorData.skin = document.getElementById('skin-input').value;
                    creatorData.hair = document.getElementById('hair-input').value;
                    creatorData.personalityTrait = document.getElementById('personality-trait-select').value;
                    creatorData.ideal = document.getElementById('ideal-select').value;
                    creatorData.bond = document.getElementById('bond-select').value;
                    creatorData.flaw = document.getElementById('flaw-select').value;
                    
                    const baseLanguages = dndData.races[creatorData.race].languages.split(', ').map(l => l.replace('and ', '').trim());
                    const chosenLanguages = Array.from(document.querySelectorAll('.language-checkbox:checked')).map(cb => cb.value);
                    creatorData.languages = [...new Set([...baseLanguages, ...chosenLanguages])]; // Combine and remove duplicates

                    creatorData.backstory = document.getElementById('backstory-input').value;

                    populateProficiencies();
                    populateFeats();
                    goToStep(6);
                });
                document.getElementById('creator-prev-6').addEventListener('click', () => goToStep(5));
                document.getElementById('creator-next-6').addEventListener('click', () => {
                    const classData = dndData.classes[creatorData.class];
                    const numChoices = classData.proficiencies.skills.count;
                    const checked = document.querySelectorAll('.proficiency-checkbox:checked').length;
                    if (checked < numChoices) {
                        showModal(`Please select ${numChoices} skill proficiencies.`);
                        return;
                    }
                    creatorData.proficiencies = Array.from(document.querySelectorAll('.proficiency-checkbox:checked')).map(cb => cb.value);
                    creatorData.feat = document.getElementById('feat-select')?.value || null;
                    populateEquipment();
                    goToStep(7);
                });
                document.getElementById('creator-prev-7').addEventListener('click', () => goToStep(6));
                document.getElementById('creator-next-7').addEventListener('click', () => {
                    creatorData.equipment = [];
                    let allChoicesMade = true;
                    document.querySelectorAll('.equipment-choice-group').forEach(group => {
                        if (group.querySelector('input[type=radio]') && !group.querySelector('input:checked')) {
                            allChoicesMade = false;
                        }
                    });

                    if (!allChoicesMade) {
                        showModal("Please make a selection for each equipment choice.");
                        return;
                    }

                    document.querySelectorAll('.equipment-choice-group').forEach(group => {
                        const selected = group.querySelector('input:checked')?.value;
                        if (selected) creatorData.equipment.push(selected);
                        const fixed = group.dataset.fixed;
                        if (fixed) creatorData.equipment.push(fixed);
                    });

                    const isSpellcaster = dndData.classes[creatorData.class].spellcasting;
                    if (isSpellcaster) {
                        populateSpells();
                        goToStep(8);
                    } else {
                        creatorData.spells = null;
                        reviewCharacter();
                        goToStep(9);
                    }
                });
                document.getElementById('creator-prev-8').addEventListener('click', () => goToStep(7));
                document.getElementById('creator-next-8').addEventListener('click', () => {
                    reviewCharacter();
                    goToStep(9);
                });
                document.getElementById('creator-prev-9').addEventListener('click', () => {
                    const isSpellcaster = dndData.classes[creatorData.class].spellcasting;
                    if(isSpellcaster) goToStep(8); else goToStep(7);
                });

                 document.getElementById('finish-character-btn').addEventListener('click', async () => {
                    const finalCharacter = {
                        name: creatorData.name,
                        class: `${creatorData.class} 1`,
                        notes: document.getElementById('review-output').innerText // Save the full review as notes
                    };
                    await saveCharacter(finalCharacter);
                    showModal(`${creatorData.name} has been saved to your characters!`);
                    resetCreator();
                });

                creatorNavSetupDone = true;
            };

            const reviewCharacter = () => {
                const reviewOutput = document.getElementById('review-output');
                
                // Collect Selections from spell step if applicable
                if (dndData.classes[creatorData.class].spellcasting) {
                    creatorData.spells = {
                        cantrips: Array.from(document.querySelectorAll('.cantrip-checkbox:checked')).map(cb => cb.value),
                        level1: Array.from(document.querySelectorAll('.level1-spell-checkbox:checked')).map(cb => cb.value)
                    };
                }

                let abilities = 'Not set';
                if(creatorData.abilities) {
                    abilities = Object.keys(creatorData.abilities).map(key => `${key.substring(0,3).toUpperCase()}: ${creatorData.abilities[key].score} (${creatorData.abilities[key].modifier >= 0 ? '+' : ''}${creatorData.abilities[key].modifier})`).join(' | ');
                }

                const raceData = dndData.races[creatorData.race];
                const classData = dndData.classes[creatorData.class];
                const backgroundData = dndData.backgrounds[creatorData.background];

                let allTraits = [ ...raceData.traits, ...classData.features, backgroundData.feature ];

                let reviewHTML = `
                    <h3 class="font-title text-2xl">${creatorData.name}</h3>
                    <p>${creatorData.alignment} ${creatorData.subrace || ''} ${creatorData.race} ${creatorData.class} 1</p>
                    <p><strong>Background:</strong> ${creatorData.background}</p>
                    <p><strong>Speed:</strong> ${raceData.speed} ft. | <strong>Size:</strong> ${raceData.size}</p>
                    <p><strong>Age:</strong> ${creatorData.age || 'N/A'} | <strong>Height:</strong> ${creatorData.height || 'N/A'} | <strong>Weight:</strong> ${creatorData.weight || 'N/A'}</p>
                    <p><strong>Eyes:</strong> ${creatorData.eyes || 'N/A'} | <strong>Skin:</strong> ${creatorData.skin || 'N/A'} | <strong>Hair:</strong> ${creatorData.hair || 'N/A'}</p>
                    <hr class="my-2 border-gray-600">
                    <p><strong>Ability Scores:</strong> ${abilities}</p>
                    <p><strong>Saving Throws:</strong> ${classData.saves.join(', ')}</p>
                    <p><strong>Skills:</strong> ${[...backgroundData.skill_proficiencies, ...creatorData.proficiencies].join(', ')}</p>
                    <p><strong>Languages:</strong> ${creatorData.languages.join(', ')}</p>
                    <hr class="my-2 border-gray-600">
                    <p><strong>Personality Trait:</strong> ${creatorData.personalityTrait}</p>
                    <p><strong>Ideal:</strong> ${creatorData.ideal}</p>
                    <p><strong>Bond:</strong> ${creatorData.bond}</p>
                    <p><strong>Flaw:</strong> ${creatorData.flaw}</p>
                    <hr class="my-2 border-gray-600">
                    <h4 class="font-title text-xl mt-2">Features & Traits</h4>
                    <ul>${allTraits.map(t => `<li><strong>${t.name}:</strong> ${t.desc}</li>`).join('')}</ul>
                    <h4 class="font-title text-xl mt-2">Equipment</h4>
                    <p>${creatorData.equipment.join(', ')}</p>
                `;

                if(creatorData.spells && (creatorData.spells.cantrips.length > 0 || creatorData.spells.level1.length > 0)) {
                    reviewHTML += `
                        <hr class="my-2 border-gray-600">
                        <h4 class="font-title text-xl mt-2">Spells</h4>
                        ${creatorData.spells.cantrips.length > 0 ? `<p><strong>Cantrips:</strong> ${creatorData.spells.cantrips.join(', ')}</p>` : ''}
                        ${creatorData.spells.level1.length > 0 ? `<p><strong>1st-Level Spells:</strong> ${creatorData.spells.level1.join(', ')}</p>`: ''}
                    `;
                }

                if(creatorData.backstory) {
                     reviewHTML += `
                        <hr class="my-2 border-gray-600">
                        <h4 class="font-title text-xl mt-2">Backstory</h4>
                        <p>${creatorData.backstory.replace(/\n/g, '<br>')}</p>
                    `;
                }

                reviewOutput.innerHTML = reviewHTML;
            };
            
            const resetCreator = () => {
                creatorData = {};
                ['creator-char-name', 'backstory-input', 'age-input', 'height-input', 'weight-input', 'eyes-input', 'skin-input', 'hair-input'].forEach(id => document.getElementById(id).value = '');
                ['race-select', 'class-select', 'background-select', 'alignment-select'].forEach(id => document.getElementById(id).selectedIndex = 0);
                
                document.getElementById('subrace-select').innerHTML = '';
                document.getElementById('subrace-select').classList.add('hidden');
                document.getElementById('subclass-select').innerHTML = '';
                document.getElementById('subclass-select').classList.add('hidden');
                
                initAbilityScores();
                initCreator(); // Re-run to reset descriptions
                goToStep(1);
            };

            const initCreator = () => {
                loadDnDData();

                const raceSelect = document.getElementById('race-select');
                const subraceSelect = document.getElementById('subrace-select');
                const classSelect = document.getElementById('class-select');
                const subclassSelect = document.getElementById('subclass-select');
                const backgroundSelect = document.getElementById('background-select');
                const alignmentSelect = document.getElementById('alignment-select');
                
                // Populate dropdowns only if they are empty
                if(raceSelect.options.length === 0) Object.keys(dndData.races).forEach(r => raceSelect.add(new Option(r,r)));
                if(classSelect.options.length === 0) Object.keys(dndData.classes).forEach(c => classSelect.add(new Option(c,c)));
                if(backgroundSelect.options.length === 0) Object.keys(dndData.backgrounds).forEach(b => backgroundSelect.add(new Option(b,b)));
                if(alignmentSelect.options.length === 0) dndData.alignments.forEach(a => alignmentSelect.add(new Option(a,a)));

                const updateRaceDesc = () => {
                    const race = raceSelect.value;
                    document.getElementById('race-description').innerText = dndData.races[race].description;
                    subraceSelect.innerHTML = '';
                    dndData.races[race].subraces.forEach(sr => subraceSelect.add(new Option(sr.name, sr.name)));
                    subraceSelect.classList.toggle('hidden', dndData.races[race].subraces.length === 0);
                };
                const updateClassDesc = () => {
                    const cls = classSelect.value;
                    document.getElementById('class-description').innerText = dndData.classes[cls].description;
                    subclassSelect.innerHTML = '';
                    if (dndData.classes[cls].subclass_level === 1) {
                        dndData.classes[cls].subclasses.forEach(sc => subclassSelect.add(new Option(sc, sc)));
                        subclassSelect.classList.remove('hidden');
                    } else {
                        subclassSelect.classList.add('hidden');
                    }
                };
                const updateBackgroundDesc = () => {
                    const bg = backgroundSelect.value;
                    document.getElementById('background-description').innerText = dndData.backgrounds[bg].feature.desc;
                };

                raceSelect.onchange = updateRaceDesc;
                classSelect.onchange = updateClassDesc;
                backgroundSelect.onchange = updateBackgroundDesc;

                updateRaceDesc();
                updateClassDesc();
                updateBackgroundDesc();
                
                initAbilityScores();
                setupCreatorNav();
            };

            const initAbilityScores = () => {
                const abilityScoresContainer = document.getElementById('ability-scores');
                abilityScoresContainer.innerHTML = '';
                const pointsRemainingEl = document.getElementById('points-remaining');
                const abilities = ["Strength", "Dexterity", "Constitution", "Intelligence", "Wisdom", "Charisma"];
                let points = 27;
                creatorData.abilities = {};

                const pointCost = { 8:0, 9:1, 10:2, 11:3, 12:4, 13:5, 14:7, 15:9 };

                abilities.forEach(ability => {
                    creatorData.abilities[ability] = { score: 8, modifier: -1 };
                });
                
                const redrawScores = () => {
                    pointsRemainingEl.innerText = points;
                    abilityScoresContainer.innerHTML = '';
                    abilities.forEach(ability => {
                        const score = creatorData.abilities[ability].score;
                        const modifier = Math.floor((score - 10) / 2);
                        creatorData.abilities[ability].modifier = modifier;

                        const container = document.createElement('div');
                        container.className = 'p-2 border border-gray-600 rounded';

                        const label = document.createElement('div');
                        label.className = 'font-bold';
                        label.innerText = ability;
                        
                        const scoreDisplay = document.createElement('div');
                        const scoreEl = document.createElement('span');
                        scoreEl.className = 'text-2xl';
                        scoreEl.innerText = score;
                        
                        const modifierEl = document.createElement('span');
                        modifierEl.className = 'text-sm text-gray-400 ml-2';
                        modifierEl.innerText = `(${modifier >= 0 ? '+' : ''}${modifier})`;
                        scoreDisplay.append(scoreEl, modifierEl);

                        const btnContainer = document.createElement('div');
                        btnContainer.className = 'mt-2';
                        const plusBtn = document.createElement('button');
                        plusBtn.className = 'btn text-sm py-1 px-2 rounded ml-4';
                        plusBtn.innerText = '+';
                        plusBtn.disabled = score >= 15 || points < (pointCost[score + 1] - pointCost[score]);

                        const minusBtn = document.createElement('button');
                        minusBtn.className = 'btn text-sm py-1 px-2 rounded ml-2 bg-gray-600';
                        minusBtn.innerText = '-';
                        minusBtn.disabled = score <= 8;

                        plusBtn.onclick = () => updateScore(ability, 1);
                        minusBtn.onclick = () => updateScore(ability, -1);
                        
                        btnContainer.append(minusBtn, plusBtn);
                        container.append(label, scoreDisplay, btnContainer);
                        abilityScoresContainer.appendChild(container);
                    });
                     document.getElementById('creator-next-3').disabled = (points !== 0);
                };
                
                const updateScore = (ability, change) => {
                    let currentScore = creatorData.abilities[ability].score;
                    let newScore = currentScore + change;
                    if (newScore < 8 || newScore > 15) return;

                    let costChange = (pointCost[newScore] || 0) - (pointCost[currentScore] || 0);

                    if (points - costChange >= 0) {
                        points -= costChange;
                        creatorData.abilities[ability].score = newScore;
                        redrawScores();
                    }
                };
                
                redrawScores();
            };

            const populatePersonalityTraits = () => {
                const container = document.getElementById('personality-traits-container');
                container.innerHTML = '';
                const background = dndData.backgrounds[document.getElementById('background-select').value];
                if (!background) return;

                const createSelect = (id, label, options) => {
                    const div = document.createElement('div');
                    div.className = 'mt-2';
                    const labelEl = document.createElement('label');
                    labelEl.className = 'font-bold block mb-1';
                    labelEl.innerText = label;
                    const selectEl = document.createElement('select');
                    selectEl.id = id;
                    selectEl.className = 'input-field w-full p-2';
                    options.forEach(opt => selectEl.add(new Option(opt, opt)));
                    div.append(labelEl, selectEl);
                    return div;
                };

                container.appendChild(createSelect('personality-trait-select', 'Personality Trait', background.personalityTraits));
                container.appendChild(createSelect('ideal-select', 'Ideal', background.ideals));
                container.appendChild(createSelect('bond-select', 'Bond', background.bonds));
                container.appendChild(createSelect('flaw-select', 'Flaw', background.flaws));
            };

            const populateLanguages = () => {
                const container = document.getElementById('languages-container');
                container.innerHTML = '';
                const race = dndData.races[creatorData.race || document.getElementById('race-select').value];
                const background = dndData.backgrounds[creatorData.background || document.getElementById('background-select').value] || {languages_choices: 0};

                const racialBonusLanguages = race.languages.includes("one extra language") ? 1 : 0;
                const backgroundBonusLanguages = background.languages_choices || 0;
                const numExtra = racialBonusLanguages + backgroundBonusLanguages;

                if (numExtra > 0) {
                    const header = document.createElement('h4');
                    header.className = 'font-title text-xl mb-2';
                    header.innerText = `Choose ${numExtra} Additional Languages:`;
                    container.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = 'checkbox-grid';
                    container.appendChild(grid);
                    
                    const existingLanguages = race.languages.toLowerCase();

                    dndData.languages.forEach(lang => {
                        if (!existingLanguages.includes(lang.toLowerCase())) {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded';
                            label.innerHTML = `<input type="checkbox" value="${lang}" class="input-field language-checkbox"> <span>${lang}</span>`;
                            grid.appendChild(label);
                        }
                    });

                    grid.addEventListener('change', (e) => {
                        if (e.target.classList.contains('language-checkbox')) {
                            const checked = container.querySelectorAll('.language-checkbox:checked');
                            if (checked.length > numExtra) {
                                e.target.checked = false;
                                showModal(`You can only select ${numExtra} languages.`);
                            }
                        }
                    });
                }
            };

            const populateProficiencies = () => {
                const container = document.getElementById('proficiencies-container');
                container.innerHTML = '';
                const classData = dndData.classes[creatorData.class];
                const numChoices = classData.proficiencies.skills.count;
                const options = classData.proficiencies.skills.options;

                const header = document.createElement('h4');
                header.className = 'font-title text-xl mb-2';
                header.innerText = `Choose ${numChoices} Skill Proficiencies:`;
                container.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'checkbox-grid';
                container.appendChild(grid);

                options.forEach(skill => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded';
                    label.innerHTML = `<input type="checkbox" value="${skill}" class="input-field proficiency-checkbox"> <span>${skill}</span>`;
                    grid.appendChild(label);
                });

                grid.addEventListener('change', (e) => {
                    if (e.target.classList.contains('proficiency-checkbox')) {
                        const checked = container.querySelectorAll('.proficiency-checkbox:checked');
                        if (checked.length > numChoices) {
                            e.target.checked = false;
                            showModal(`You can only select ${numChoices} skills.`);
                        }
                    }
                });
            };

            const populateFeats = () => {
                const container = document.getElementById('feats-container');
                container.innerHTML = '';
                // This is a simplified check. A full implementation would check for Variant Human specifically.
                if (creatorData.race === "Human") {
                    // Placeholder for Variant Human logic
                }
            };

            const populateEquipment = () => {
                const container = document.getElementById('equipment-container');
                container.innerHTML = '';
                const classData = dndData.classes[creatorData.class];

                const header = document.createElement('h4');
                header.className = 'font-title text-xl mb-2';
                header.innerText = `Choose Starting Equipment:`;
                container.appendChild(header);

                classData.equipment_choices.forEach((choice, index) => {
                    const group = document.createElement('div');
                    group.className = 'equipment-choice-group mb-4 p-3 border border-gray-700 rounded';
                    
                    if (choice.options) {
                        const choiceHeader = document.createElement('p');
                        choiceHeader.className = 'font-bold mb-2';
                        choiceHeader.innerText = 'Choose one:';
                        group.appendChild(choiceHeader);
                        choice.options.forEach(opt => {
                            const label = document.createElement('label');
                            label.className = 'flex items-center space-x-2';
                            label.innerHTML = `<input type="radio" name="equip-${index}" value="${opt}" class="input-field"> <span>${opt}</span>`;
                            group.appendChild(label);
                        });
                    } else if (choice.fixed) {
                        const p = document.createElement('p');
                        p.innerText = choice.fixed;
                        group.dataset.fixed = choice.fixed;
                        group.appendChild(p);
                    }
                    container.appendChild(group);
                });
            };

            const populateSpells = () => {
                const container = document.getElementById('spells-container');
                container.innerHTML = '';
                const classData = dndData.classes[creatorData.class];
                const classSpells = dndData.spells[creatorData.class];
                if (!classSpells) return;

                // Spells known logic (simplified for level 1)
                const spellcastingInfo = {
                    Bard: {cantrips: 2, level1: 4},
                    Cleric: {cantrips: 3, level1: 'WIS Mod + Level'},
                    Druid: {cantrips: 2, level1: 'WIS Mod + Level'},
                    Paladin: {cantrips: 0, level1: 'CHA Mod + 1/2 Level'},
                    Ranger: {cantrips: 0, level1: 2},
                    Sorcerer: {cantrips: 4, level1: 2},
                    Warlock: {cantrips: 2, level1: 2},
                    Wizard: {cantrips: 3, level1: 6}, // In spellbook, can prepare INT Mod + Level
                }
                const info = spellcastingInfo[creatorData.class];

                // Cantrips
                if(info.cantrips > 0 && classSpells.cantrips && classSpells.cantrips.length > 0) {
                    const cantripContainer = document.createElement('div');
                    const cantripHeader = document.createElement('h4');
                    cantripHeader.className = 'font-title text-xl mb-2';
                    cantripHeader.innerText = `Choose ${info.cantrips} Cantrips:`;
                    cantripContainer.appendChild(cantripHeader);
                    const cantripGrid = document.createElement('div');
                    cantripGrid.className = 'checkbox-grid';
                    classSpells.cantrips.forEach(spell => {
                         const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded';
                        label.innerHTML = `<input type="checkbox" value="${spell}" class="input-field cantrip-checkbox"> <span>${spell}</span>`;
                        cantripGrid.appendChild(label);
                    });
                    cantripContainer.appendChild(cantripGrid);
                    container.appendChild(cantripContainer);

                    cantripGrid.addEventListener('change', (e) => {
                        if (e.target.classList.contains('cantrip-checkbox')) {
                            const checked = cantripContainer.querySelectorAll('.cantrip-checkbox:checked');
                            if (checked.length > info.cantrips) {
                                e.target.checked = false;
                                showModal(`You can only select ${info.cantrips} cantrips.`);
                            }
                        }
                    });
                }
                
                // Level 1 Spells
                if(info.level1 && classSpells.level1 && classSpells.level1.length > 0){
                    const level1Container = document.createElement('div');
                    const level1Header = document.createElement('h4');
                    level1Header.className = 'font-title text-xl mb-2';
                    const numLevel1 = (typeof info.level1 === 'number') ? info.level1 : `your prepared amount`;
                    level1Header.innerText = `Choose ${numLevel1} 1st-Level Spells:`;
                    if (creatorData.class === 'Wizard') {
                        level1Header.innerText = `Choose 6 1st-Level Spells for your Spellbook:`;
                    }
                    level1Container.appendChild(level1Header);
                    const level1Grid = document.createElement('div');
                    level1Grid.className = 'checkbox-grid';
                    classSpells.level1.forEach(spell => {
                         const label = document.createElement('label');
                        label.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded';
                        label.innerHTML = `<input type="checkbox" value="${spell}" class="input-field level1-spell-checkbox"> <span>${spell}</span>`;
                        level1Grid.appendChild(label);
                    });
                    level1Container.appendChild(level1Grid);
                    container.appendChild(level1Container);

                    if (typeof info.level1 === 'number') {
                        level1Grid.addEventListener('change', (e) => {
                            if (e.target.classList.contains('level1-spell-checkbox')) {
                                const checked = level1Container.querySelectorAll('.level1-spell-checkbox:checked');
                                if (checked.length > info.level1) {
                                    e.target.checked = false;
                                    showModal(`You can only select ${info.level1} 1st-level spells.`);
                                }
                            }
                        });
                    }
                }
            };
            
             // --- INITIAL LOAD ---
            initCreator(); 
            switchTab('session');
        });
    </script>
</body>
</html>
